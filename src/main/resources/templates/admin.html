<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <title>Admin Dashboard - E-Commerce Store</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
    
    /* Professional Tracking Input Styling */
input[id^="tracking"] {
    transition: all 0.3s ease !important;
}

input[id^="tracking"]:enabled {
    background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%) !important;
    border: 2px solid #3b82f6 !important;
    color: #1e40af !important;
    font-weight: 700 !important;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15) !important;
}

input[id^="tracking"]:enabled:hover {
    border-color: #2563eb !important;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25) !important;
}

input[id^="tracking"]:enabled:focus {
    outline: none !important;
    border-color: #2563eb !important;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2) !important;
    transform: scale(1.02);
}

input[id^="tracking"]:disabled {
    background: #f9fafb !important;
    border: 2px solid #e5e7eb !important;
    color: #9ca3af !important;
    cursor: not-allowed !important;
}

/* Tracking field for RETURNED orders */
input[id^="tracking"][disabled][value]:not([value=""]) {
    background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%) !important;
    border: 2px solid #f59e0b !important;
    color: #92400e !important;
    font-weight: 600 !important;
}

/* Professional placeholder styling */
input[id^="tracking"]::placeholder {
    color: #9ca3af;
    font-style: italic;
    font-weight: 500;
}

input[id^="tracking"]:enabled::placeholder {
    color: #60a5fa;
    font-weight: 600;
}
        *, *::before, *::after {
            box-sizing: border-box;
        }

        html, body {
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }

        .admin-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .page-header {
            margin-bottom: 3rem;
            text-align: center;
        }

        .page-title {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: #6b7280;
            font-size: 1.1rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 2px solid #f3f4f6;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: #1f2937;
            margin-bottom: 0.3rem;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Filters Section */
        .filters-section {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
            border: 2px solid #f3f4f6;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-group label {
            font-weight: 600;
            color: #374151;
            font-size: 0.95rem;
        }

        .filter-select, .search-input {
            padding: 0.6rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .filter-select:focus, .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-input {
            min-width: 200px;
        }

        /* Section Cards */
        .section-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            border: 2px solid #f3f4f6;
            overflow: hidden;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f9fafb 0%, #e0e7ff 100%);
            border-bottom: 2px solid #e5e7eb;
        }

        .section-header:hover {
            background: linear-gradient(135deg, #f3f4f6 0%, #dbeafe 100%);
        }

        .section-title {
            font-size: 1.3rem;
            color: #1f2937;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toggle-icon {
            font-size: 1.5rem;
            color: #667eea;
            transition: transform 0.3s ease;
        }

        .toggle-icon.expanded {
            transform: rotate(180deg);
        }

        .section-content {
            padding: 2rem;
            display: none;
        }

        .section-content.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Orders Table */
        .orders-table-wrapper {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 2px solid #f3f4f6;
            overflow: hidden;
        }

        .table-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .orders-table, .users-table {
            width: 100%;
            border-collapse: collapse;
        }

        .orders-table thead, .users-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .orders-table th, .users-table th {
            padding: 1.2rem 1rem;
            text-align: center;
            font-weight: 700;
            color: white;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: none;
        }

        .orders-table td, .users-table td {
            padding: 1.2rem 1rem;
            border-bottom: 1px solid #f3f4f6;
            text-align: center;
        }

        .orders-table tbody tr, .users-table tbody tr {
            transition: all 0.3s ease;
            background: white;
        }

        .orders-table tbody tr:nth-child(even), .users-table tbody tr:nth-child(even) {
            background: #f9fafb;
        }

        .orders-table tbody tr:hover, .users-table tbody tr:hover {
            background: #f3f4f6;
            transform: scale(1.01);
        }

        .order-status {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            display: inline-block;
        }

        .status-pending { background: #fef3c7; color: #92400e; }
        .status-processing { background: #dbeafe; color: #1e40af; }
        .status-shipped { background: #e0e7ff; color: #4338ca; }
        .status-delivered { background: #d1fae5; color: #065f46; }
        .status-cancelled { background: #fee2e2; color: #991b1b; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .status-returned { background: #fde68a; color: #78350f; }

        .return-notice {
            background: #fef3c7;
            border-left: 3px solid #f59e0b;
            padding: 0.4rem 0.6rem;
            border-radius: 4px;
            margin-top: 0.3rem;
            font-size: 0.7rem;
            color: #92400e;
            font-weight: 600;
        }

        .role-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            display: inline-block;
        }

        .role-admin {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .role-user {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        /* Modals */
        .custom-modal {
            display: none;
            position: fixed;
            top: 2%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
            z-index: 10000;
            min-width: 600px;
            max-width: 900px;
            max-height: 96vh;
            overflow-y: auto;
            text-align: center;
        }
        
        .custom-modal.show {
            display: block;
            animation: modalSlideDown 0.3s ease;
        }
        
        @keyframes modalSlideDown {
            from { opacity: 0; top: -10%; }
            to { opacity: 1; top: 2%; }
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            z-index: 9999;
        }
        
        .modal-overlay.show {
            display: block;
        }

        .order-details-content {
            text-align: left;
            margin: 1.5rem 0;
            max-width: 100%;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
            gap: 1rem;
        }
        
        .detail-section {
            margin: 1rem 0;
            padding: 1.5rem;
            background: #f9fafb;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .detail-section h4 {
            margin-bottom: 1rem;
            color: #1f2937;
            font-size: 1.1rem;
        }

        .info-box {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            border-radius: 8px;
            color: #1e40af;
            margin: 1rem 0;
            font-size: 0.95rem;
        }

        input[id^="tracking"]:enabled {
            background: #dbeafe !important;
            border-color: #3b82f6 !important;
        }

        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid #f3f4f6;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .action-btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        .btn-view {
            background: #3b82f6;
            color: white;
        }

        .btn-view:hover {
            background: #2563eb;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .btn-update {
            background: #10b981;
            color: white;
        }

        .btn-update:hover {
            background: #059669;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .btn-delete:hover {
            background: #dc2626;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        /* File Upload Styles */
        .file-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            background: #f9fafb;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 1rem 0;
        }

        .file-upload-area:hover {
            border-color: #667eea;
            background: #f3f4f6;
        }

        .file-upload-area.has-file {
            border-color: #10b981;
            background: #d1fae5;
        }

        #labelPreviewContent iframe {
            width: 100%;
            height: 600px;
            border: none;
        }

        /* Mobile Close Button - Hidden on Desktop */
        #mobileCloseBtn {
            display: none;
        }

        /* ============================================
   RESPONSIVE STYLES FOR SMALL SCREENS
   ============================================ */
@media (max-width: 768px) {
    body {
        overflow-x: hidden;
        width: 100%;
        max-width: 100vw;
    }

    .admin-container {
        padding: 0 0.5rem;
        margin: 0.5rem auto;
        max-width: 100%;
        width: 100%;
    }

    .page-header {
        margin-bottom: 1rem;
        padding: 0 0.25rem;
    }

    .page-title {
        font-size: 1.5rem;
    }

    .page-subtitle {
        font-size: 0.85rem;
    }

    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
    }

    .stat-card {
        padding: 0.75rem 0.5rem;
    }

    .stat-value {
        font-size: 1.3rem;
    }

    .stat-icon {
        font-size: 1.5rem;
    }

    .stat-label {
        font-size: 0.65rem;
    }

    /* Filters Section - Mobile Optimized */
    .filters-section {
        flex-direction: column;
        align-items: stretch;
        padding: 0.5rem;
        gap: 0.5rem;
    }

    .filter-group {
        width: 100%;
        flex-direction: column;
        align-items: stretch;
        gap: 0.25rem;
    }

    .filter-group label {
        font-size: 0.75rem;
        margin-bottom: 0.15rem;
    }

    .filter-select, .search-input {
        width: 100% !important;
        min-width: 100% !important;
        max-width: 100% !important;
        padding: 0.4rem 0.5rem !important;
        font-size: 0.75rem !important;
        box-sizing: border-box;
        height: 36px !important;
    }

    /* Section Content Forms */
    .section-content > form > div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
    }

    /* Hide Table Headers on Mobile */
    .orders-table thead, .users-table thead {
        display: none;
    }

    .orders-table, .users-table,
    .orders-table tbody, .users-table tbody,
    .orders-table tr, .users-table tr {
        display: block;
        width: 100%;
    }

    /* Order/User Cards - Compact */
    .orders-table tr, .users-table tr {
        margin-bottom: 0.75rem;
        border: 1.5px solid #e5e7eb;
        border-radius: 8px;
        padding: 0.5rem;
        background: white;
        box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        width: 100%;
        max-width: 100%;
        overflow: hidden;
        box-sizing: border-box;
    }

    .orders-table tr:hover, .users-table tr:hover {
        transform: none;
    }

    /* Table Cells - Mobile Layout */
    .orders-table td, .users-table td {
        display: block;
        width: 100%;
        max-width: 100%;
        text-align: left !important;
        padding: 0.35rem 0;
        border-bottom: 1px solid #f3f4f6;
        word-wrap: break-word;
        overflow-wrap: break-word;
        box-sizing: border-box;
    }

    .orders-table td:last-child, .users-table td:last-child {
        border-bottom: none;
        padding-bottom: 0.35rem;
        padding-top: 0.5rem;
    }

    /* Data Labels */
    .orders-table td::before, .users-table td::before {
        content: attr(data-label);
        display: block;
        font-weight: 700;
        color: #667eea;
        font-size: 0.65rem;
        text-transform: uppercase;
        margin-bottom: 0.25rem;
        letter-spacing: 0.3px;
    }

    .orders-table td:last-child::before, .users-table td:last-child::before {
        content: "ACTIONS";
        margin-bottom: 0.4rem;
    }

    /* DROPDOWN (SELECT) - VERY COMPACT */
    .orders-table select, .users-table select {
        width: 100% !important;
        max-width: 100% !important;
        min-width: 0 !important;
        box-sizing: border-box !important;
        padding: 0.35rem 1.5rem 0.35rem 0.4rem !important;
        font-size: 0.7rem !important;
        margin: 0 !important;
        height: 32px !important;
        line-height: 1.2 !important;
        border: 1.5px solid #d1d5db !important;
        border-radius: 5px !important;
        background-color: white !important;
        appearance: none !important;
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23667eea' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") !important;
        background-repeat: no-repeat !important;
        background-position: right 0.3rem center !important;
        background-size: 0.9em !important;
        cursor: pointer !important;
        font-weight: 600 !important;
        color: #374151 !important;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
    }

    /* Dropdown options */
    .orders-table select option, .users-table select option {
        padding: 0.4rem !important;
        font-size: 0.75rem !important;
    }

    /* TEXT INPUT (TRACKING) - COMPACT */
    .orders-table input[type="text"], .users-table input[type="text"] {
        width: 100% !important;
        max-width: 100% !important;
        min-width: 0 !important;
        box-sizing: border-box !important;
        padding: 0.35rem 0.4rem !important;
        font-size: 0.7rem !important;
        margin: 0 !important;
        height: 32px !important;
        line-height: 1.2 !important;
        border: 1.5px solid #d1d5db !important;
        border-radius: 5px !important;
        font-family: monospace !important;
    }

    /* Tracking input when enabled */
    .orders-table input[id^="tracking"]:enabled {
        background: #dbeafe !important;
        border-color: #3b82f6 !important;
        color: #1e40af !important;
        font-weight: 600 !important;
    }

    /* Tracking input when disabled */
    .orders-table input[id^="tracking"]:disabled {
        background: #f3f4f6 !important;
        border-color: #e5e7eb !important;
        color: #9ca3af !important;
    }

    /* ACTION BUTTONS - VERY COMPACT */
    .orders-table td:last-child,
    .users-table td:last-child {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        padding: 0.5rem 0 0.35rem 0 !important;
        width: 100%;
    }

    .action-btn {
        padding: 0.45rem 0.5rem !important;
        font-size: 0.7rem !important;
        margin-bottom: 0 !important;
        width: 100% !important;
        max-width: 100% !important;
        min-height: 32px !important;
        height: 32px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        box-sizing: border-box !important;
        white-space: nowrap !important;
        text-align: center !important;
        font-weight: 700 !important;
        border-radius: 5px !important;
        line-height: 1 !important;
    }

    /* Table Header - Mobile */
    .table-header {
        flex-direction: column;
        gap: 0.5rem;
        text-align: center;
        padding: 0.75rem 0.5rem;
    }

    .table-header button {
        padding: 0.45rem 0.75rem !important;
        font-size: 0.75rem !important;
        width: 100%;
        max-width: 100%;
        height: 36px !important;
    }

    .table-title {
        font-size: 1rem;
    }

    /* Filter Section Buttons */
    .filters-section button {
        padding: 0.45rem 0.75rem !important;
        font-size: 0.75rem !important;
        height: 36px !important;
    }

    /* MODALS - FULL SCREEN ON MOBILE */
    .custom-modal {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        transform: none !important;
        min-width: 100% !important;
        max-width: 100% !important;
        width: 100% !important;
        height: 100vh !important;
        max-height: 100vh !important;
        padding: 1.5rem 1rem 1rem 1rem !important;
        margin: 0 !important;
        border-radius: 0 !important;
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch;
    }

    /* Main Close Button - Sticky at Bottom - SMALLER SIZE */
    #mainCloseBtn {
        position: sticky !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        width: calc(100% + 2rem) !important;
        margin: 1rem -1rem -1rem -1rem !important;
        padding: 0.6rem !important;
        border-radius: 0 !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        font-weight: 600 !important;
        font-size: 0.85rem !important;
        box-shadow: 0 -4px 15px rgba(0,0,0,0.2) !important;
        z-index: 100 !important;
        border: none !important;
        text-transform: uppercase !important;
        letter-spacing: 0.5px !important;
    }

    /* Ensure modal content has proper padding */
    #alertContent {
        padding-bottom: 1rem !important;
        margin-bottom: 0.5rem !important;
    }

    #customAlert {
        font-size: 0.8rem;
    }

    #alertTitle {
        font-size: 1.1rem !important;
        margin-top: 0.4rem !important;
        margin-bottom: 0.5rem !important;
    }

    #alertMessage {
        font-size: 0.8rem !important;
    }

    #alertIcon {
        font-size: 2.2rem !important;
        margin-top: 0.3rem !important;
        margin-bottom: 0.5rem !important;
    }

    .order-details-content {
        margin: 0.3rem 0 !important;
    }

    .order-details-content > div[style*="grid"] {
        display: block !important;
    }

    .detail-section {
        padding: 0.65rem !important;
        margin: 0.5rem 0 !important;
    }

    .detail-section h4 {
        font-size: 0.9rem !important;
        margin-bottom: 0.5rem !important;
    }

    .detail-row {
        display: block !important;
        padding: 0.3rem 0 !important;
    }

    .detail-row > span, .detail-row > div {
        display: block !important;
        margin-bottom: 0.2rem;
        font-size: 0.75rem;
    }

    .detail-row > span:first-child, .detail-row > div:first-child {
        color: #667eea !important;
        font-weight: 700 !important;
        font-size: 0.7rem !important;
    }

    /* Delete Confirmation Modal */
    #deleteConfirmModal {
        min-width: 100% !important;
        padding: 1.5rem 1rem 1rem 1rem !important;
    }

    #deleteConfirmModal > div[style*="display:flex"] {
        flex-direction: column !important;
        gap: 0.4rem !important;
    }

    #deleteConfirmModal > div[style*="display:flex"] button {
        width: 100% !important;
        min-width: 100% !important;
        max-width: 100% !important;
        margin: 0 !important;
        padding: 0.55rem !important;
        font-size: 0.8rem !important;
    }

    /* Section Content */
    .section-content {
        padding: 0.75rem !important;
    }

    .info-box {
        padding: 0.6rem !important;
        font-size: 0.75rem !important;
    }

    .section-content form button[type="submit"] {
        padding: 0.55rem 0.75rem !important;
        font-size: 0.8rem !important;
    }

    /* Order Status Badges */
    .order-status {
        padding: 0.25rem 0.45rem !important;
        font-size: 0.65rem !important;
        display: inline-block;
        max-width: fit-content;
    }

    .return-notice {
        font-size: 0.6rem !important;
        padding: 0.3rem 0.5rem !important;
    }

    .role-badge {
        padding: 0.25rem 0.45rem !important;
        font-size: 0.65rem !important;
    }

    #ordersContainer {
        padding: 0.5rem !important;
    }

    .section-header {
        padding: 0.75rem 0.5rem;
    }

    .section-title {
        font-size: 0.9rem;
    }

    .orders-table-wrapper {
        overflow-x: hidden;
        max-width: 100%;
        width: 100%;
    }

    /* Tracking Status Indicator */
    .orders-table td > div[id^="trackingStatus"] {
        font-size: 0.6rem !important;
        margin-top: 0.15rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Small text elements */
    .orders-table td small,
    .orders-table td div,
    .users-table td small,
    .users-table td div {
        font-size: 0.75rem;
        line-height: 1.3;
    }

    .orders-table td strong,
    .users-table td strong {
        font-size: 0.8rem;
    }

    #labelPreviewContent iframe {
        height: 70vh;
    }

    #labelPreviewModal {
        min-width: 100% !important;
        max-width: 100% !important;
    }

    .file-upload-area {
        padding: 1.5rem 1rem;
    }
}

/* EXTRA SMALL SCREENS (< 480px) */
@media (max-width: 480px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }

    .stat-card {
        padding: 0.75rem 0.5rem;
    }

    .stat-value {
        font-size: 1.2rem;
    }

    .page-title {
        font-size: 1.3rem;
    }

    .section-title {
        font-size: 0.85rem;
    }

    .orders-table td, .users-table td {
        padding: 0.3rem 0;
    }

    .orders-table td::before, .users-table td::before {
        font-size: 0.6rem;
        margin-bottom: 0.2rem;
    }

    /* EXTRA COMPACT for very small screens */
    .action-btn {
        padding: 0.4rem 0.45rem !important;
        font-size: 0.65rem !important;
        min-height: 30px !important;
        height: 30px !important;
    }

    .orders-table select, .users-table select {
        padding: 0.3rem 1.4rem 0.3rem 0.35rem !important;
        font-size: 0.65rem !important;
        height: 30px !important;
    }

    .orders-table input[type="text"], .users-table input[type="text"] {
        padding: 0.3rem 0.35rem !important;
        font-size: 0.65rem !important;
        height: 30px !important;
    }

    .custom-modal {
        padding: 1.25rem 0.85rem 0.85rem 0.85rem !important;
    }

    .detail-section {
        padding: 0.55rem !important;
        margin: 0.4rem 0 !important;
    }

    #alertTitle {
        font-size: 1rem !important;
    }

    #alertIcon {
        font-size: 1.8rem !important;
    }

    .table-title {
        font-size: 0.95rem;
    }

    .filter-select, .search-input {
        padding: 0.35rem 0.45rem !important;
        font-size: 0.7rem !important;
        height: 32px !important;
    }

    .orders-table tr, .users-table tr {
        padding: 0.45rem;
    }

    .orders-table td small,
    .orders-table td div,
    .users-table td small,
    .users-table td div {
        font-size: 0.7rem;
    }

    .orders-table td strong,
    .users-table td strong {
        font-size: 0.75rem;
    }

    /* Smaller close button on very small screens */
    #mainCloseBtn {
        padding: 0.55rem !important;
        font-size: 0.8rem !important;
    }
}
    </style>
</head>
<body>
    <!-- Custom Alert Modal -->
    <div class="modal-overlay" id="alertOverlay" onclick="closeCustomAlert()"></div>
    <div class="custom-modal" id="customAlert">
        <div id="alertIcon" style="font-size:4rem;margin-bottom:1rem;">‚úÖ</div>
        <h3 id="alertTitle" style="font-size:1.8rem;margin-bottom:1rem;color:#1f2937;">Success</h3>
        <p id="alertMessage" style="color:#6b7280;font-size:1.1rem;margin-bottom:2rem;">Operation completed successfully</p>
        <div id="alertContent"></div>
        <button class="btn" onclick="closeCustomAlert()" id="mainCloseBtn" style="margin-top:1.5rem;width:auto;padding:0.8rem 2.5rem;">Close</button>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteOverlay" onclick="closeDeleteConfirm()"></div>
    <div class="custom-modal" id="deleteConfirmModal" style="min-width:500px;">
        <div style="font-size:4rem;margin-bottom:1rem;color:#ef4444;">‚ö†Ô∏è</div>
        <h3 style="color:#ef4444;font-size:1.8rem;margin-bottom:1rem;">Delete Order?</h3>
        <p style="color:#6b7280;font-size:1.1rem;margin-bottom:1.5rem;">This action cannot be undone!</p>
        <div id="deleteOrderInfo" style="background:#fee2e2;padding:1.5rem;border-radius:12px;margin:1.5rem 0;border-left:4px solid #ef4444;">
            <p style="margin:0;color:#991b1b;"><strong>Order ID:</strong> #<span id="deleteOrderId"></span></p>
            <p style="margin:0.5rem 0 0 0;color:#991b1b;"><strong>Customer:</strong> <span id="deleteCustomerName"></span></p>
        </div>
        <div style="display:flex;gap:1rem;margin-top:2rem;flex-wrap:wrap;">
            <button onclick="closeDeleteConfirm()" class="btn" style="flex:1;background:linear-gradient(135deg, #6b7280 0%, #4b5563 100%);min-width:120px;">Cancel</button>
            <button onclick="deleteOrderConfirmed()" class="btn btn-danger" style="flex:1;min-width:120px;">Yes, Delete Order</button>
        </div>
    </div>

    <!-- Shipping Label Preview Modal -->
    <div class="modal-overlay" id="labelOverlay" onclick="closeLabelPreview()"></div>
    <div class="custom-modal" id="labelPreviewModal" style="min-width:700px;max-width:900px;">
        <div style="border-bottom:2px solid #e5e7eb;padding-bottom:1.5rem;margin-bottom:1.5rem;">
            <h3 style="font-size:1.8rem;margin-bottom:0.5rem;color:#1f2937;">üìÑ Return Shipping Label</h3>
            <p style="color:#6b7280;font-size:1rem;">Order #<span id="labelOrderId"></span> - <span id="labelCustomerEmail"></span></p>
        </div>
        
        <!-- File Upload Area -->
        <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('labelFileInput').click()">
            <input type="file" id="labelFileInput" accept=".pdf" style="display:none;" onchange="handleFileUpload(event)">
            <div id="uploadPrompt">
                <div style="font-size:3rem;margin-bottom:1rem;">üìé</div>
                <h4 style="color:#1f2937;margin-bottom:0.5rem;">Attach Custom Shipping Label</h4>
                <p style="color:#6b7280;font-size:0.95rem;">Click to browse or drag and drop your PDF label here</p>
                <p style="color:#9ca3af;font-size:0.85rem;margin-top:0.5rem;">Supported format: PDF only</p>
            </div>
            <div id="uploadedFile" style="display:none;">
                <div style="font-size:3rem;margin-bottom:1rem;color:#10b981;">‚úÖ</div>
                <h4 style="color:#10b981;margin-bottom:0.5rem;">Label Attached</h4>
                <p style="color:#1f2937;font-size:1rem;font-weight:600;" id="fileName"></p>
                <p style="color:#6b7280;font-size:0.85rem;margin-top:0.5rem;">Click to change file</p>
            </div>
        </div>
        
        <!-- OR Divider -->
        <div style="display:flex;align-items:center;gap:1rem;margin:1.5rem 0;">
            <div style="flex:1;height:1px;background:#e5e7eb;"></div>
            <span style="color:#6b7280;font-weight:600;">OR</span>
            <div style="flex:1;height:1px;background:#e5e7eb;"></div>
        </div>
        
        <!-- Generated Label Preview -->
        <div id="labelPreviewContent" style="border:2px solid #e5e7eb;border-radius:8px;overflow:hidden;background:#f9fafb;">
            <div style="text-align:center;padding:3rem;">
                <div class="loading-spinner"></div>
                <p style="color:#6b7280;margin-top:1rem;">Generating label...</p>
            </div>
        </div>
        
        <div style="display:flex;gap:1rem;margin-top:1.5rem;flex-wrap:wrap;">
            <button onclick="closeLabelPreview()" class="btn" style="flex:1;min-width:120px;background:#6b7280;">Close</button>
            <button onclick="downloadCurrentLabel()" class="btn" style="flex:1;min-width:120px;background:#3b82f6;">
                üíæ Download PDF
            </button>
            <button onclick="sendCurrentLabel()" class="btn btn-success" id="sendLabelBtn" style="flex:1;min-width:120px;background:#10b981;">
                üìß Send to Customer
            </button>
        </div>
    </div>

<div class="nav-overlay" id="navOverlay" onclick="toggleMobileMenu()"></div>

<nav class="navbar">
    <h1 onclick="window.location.href='/'">üõí E-Commerce Store</h1>
    
    <button class="menu-toggle" id="menuToggle" onclick="toggleMobileMenu()">‚ò∞</button>
    
    <div class="nav-links" id="navLinks">
        <a href="/">Home</a>
        <a href="/web/admin" id="adminLink" style="display:none;">Dashboard</a>
        <a href="/web/products">Products</a>
        <a href="/web/cart">Cart (<span id="cartCount">0</span>)</a>
        <a href="/web/orders" id="ordersLink" style="display:none;">My Orders</a>
        <a href="/web/profile" id="profileLink" style="display:none;">Profile</a>
        
        <span id="userName"></span>
        <button id="logoutBtn" style="display:none;" onclick="logout()">Logout</button>
    </div>
</nav>

    <div class="admin-container">
        <div class="page-header">
            <h1 class="page-title">üëë Admin Dashboard</h1>
            <p class="page-subtitle">Manage your store, products, and orders</p>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üì¶</div>
                <div class="stat-value" id="totalOrders">0</div>
                <div class="stat-label">Total Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-value" id="totalUsers">0</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üõçÔ∏è</div>
                <div class="stat-value" id="totalProducts">0</div>
                <div class="stat-label">Total Products</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-value">$<span id="totalRevenue">0</span></div>
                <div class="stat-label">Total Revenue</div>
            </div>
        </div>

        <!-- NEW: User Management Section -->
        <div class="section-card">
            <div class="section-header" onclick="toggleSection('usersSection')">
                <div class="section-title">üë• User Management</div>
                <div class="toggle-icon" id="usersToggle">‚ñº</div>
            </div>
            <div class="section-content" id="usersSection">
                <div style="background:#e0e7ff;padding:1.5rem;border-radius:12px;margin-bottom:1.5rem;border-left:4px solid #667eea;">
                    <p style="margin:0;color:#4338ca;"><strong>‚ÑπÔ∏è Registered Users:</strong> <span id="registeredUsersCount">0</span></p>
                    <p style="margin:0.5rem 0 0 0;color:#4338ca;">Admins: <strong><span id="adminUsersCount">0</span></strong> | Regular Users: <strong><span id="regularUsersCount">0</span></strong></p>
                </div>
                
                <div id="usersContainer" style="margin-top:1.5rem;">
                    <div style="text-align:center;padding:2rem;">
                        <div class="loading-spinner"></div>
                        <p style="color:#6b7280;margin-top:1rem;">Loading users...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Returned Orders & Shipping Labels Section -->
        <div class="section-card">
            <div class="section-header" onclick="toggleSection('returnedOrdersSection')">
                <div class="section-title">üîÑ Returns - Shipping Labels</div>
                <div class="toggle-icon" id="returnedOrdersToggle">‚ñº</div>
            </div>
            <div class="section-content" id="returnedOrdersSection">
                <div style="background:#fef3c7;padding:1.5rem;border-radius:12px;margin-bottom:1.5rem;border-left:4px solid #f59e0b;">
                    <p style="margin:0;color:#92400e;"><strong>üì¶ Returned Orders:</strong> <span id="returnedOrdersCount">0</span></p>
                    <p style="margin:0.5rem 0 0 0;color:#92400e;">Generate labels or attach custom labels to send to customers</p>
                </div>
                
                <div id="returnedOrdersContainer" style="margin-top:1.5rem;">
                    <div style="text-align:center;padding:2rem;">
                        <div class="loading-spinner"></div>
                        <p style="color:#6b7280;margin-top:1rem;">Loading returned orders...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shipping Settings Section -->
        <div class="section-card">
            <div class="section-header" onclick="toggleSection('shippingSection')">
                <div class="section-title">üöö Shipping Settings</div>
                <div class="toggle-icon" id="shippingToggle">‚ñº</div>
            </div>
            <div class="section-content" id="shippingSection">
                <div style="background:#d1fae5;padding:1.5rem;border-radius:12px;margin-bottom:1.5rem;border-left:4px solid #10b981;">
                    <p style="margin:0;color:#065f46;"><strong>‚ÑπÔ∏è Current Settings:</strong></p>
                    <p style="margin:0.5rem 0 0 0;color:#065f46;">Shipping Cost: <strong>$<span id="currentShippingCost">10.00</span></strong></p>
                    <p style="margin:0.5rem 0 0 0;color:#065f46;">Free Shipping Threshold: <strong>$<span id="currentThreshold">50.00</span></strong></p>
                </div>
                
                <form id="shippingConfigForm">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:2rem;">
                        <div class="form-group">
                            <label>Shipping Cost ($)</label>
                            <input type="number" id="shippingCost" step="0.01" min="0" required placeholder="e.g., 10.00">
                            <small style="color:#6b7280;">Cost charged for orders below threshold</small>
                        </div>
                        <div class="form-group">
                            <label>Free Shipping Threshold ($)</label>
                            <input type="number" id="freeShippingThreshold" step="0.01" min="0" required placeholder="e.g., 50.00">
                            <small style="color:#6b7280;">Orders above this get free shipping</small>
                        </div>
                    </div>
                    
                    <div class="info-box">
                        <p style="margin:0;font-weight:600;">üí° Example</p>
                        <p style="margin:0.5rem 0 0 0;font-size:0.9rem;">
                            If shipping cost is $10 and threshold is $50, customers pay $10 for orders under $50, and get free shipping for $50+
                        </p>
                    </div>
                    
                    <button type="submit" class="btn btn-success" style="width:100%;margin-top:1rem;">üíæ Save Shipping Settings</button>
                </form>
            </div>
        </div>

        <!-- Add Product Section -->
        <div class="section-card">
            <div class="section-header" onclick="toggleSection('productSection')">
                <div class="section-title">‚ûï Add New Product</div>
                <div class="toggle-icon" id="productToggle">‚ñº</div>
            </div>
            <div class="section-content" id="productSection">
                <form id="addProductForm">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1.5rem;">
                        <div class="form-group">
                            <label>Product Name</label>
                            <input type="text" id="productName" required>
                        </div>
                        <div class="form-group">
                            <label>Price ($)</label>
                            <input type="number" id="productPrice" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="productDescription" required rows="3" style="resize:vertical;"></textarea>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:1.5rem;">
                        <div class="form-group">
                            <label>Category</label>
                            <input type="text" id="productCategory" required>
                        </div>
                        <div class="form-group">
                            <label>Stock Quantity</label>
                            <input type="number" id="productStock" required min="0">
                        </div>
                        <div class="form-group">
                            <label>Image URL</label>
                            <input type="text" id="productImage" value="https://via.placeholder.com/300">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success" style="width:100%;margin-top:1rem;">‚ûï Add Product</button>
                </form>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filters-section" id="filtersSection" style="display:none;">
            <div class="filter-group">
                <label>Search By Order ID:</label>
                <input type="text" class="search-input" id="orderIdSearch" placeholder="Enter Order ID..." oninput="filterOrders()">
            </div>
            <div class="filter-group">
                <label>Search By Customer:</label>
                <input type="text" class="search-input" id="customerSearch" placeholder="Customer name or email..." oninput="filterOrders()">
            </div>
            <div class="filter-group">
                <label>Status:</label>
                <select class="filter-select" id="statusFilter" onchange="filterOrders()">
                    <option value="all">All Statuses</option>
                    <option value="PENDING">Pending</option>
                    <option value="PROCESSING">Processing</option>
                    <option value="SHIPPED">Shipped</option>
                    <option value="DELIVERED">Delivered</option>
                    <option value="CANCELLED">Cancelled</option>
                    <option value="RETURNED">Returned</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Sort by:</label>
                <select class="filter-select" id="sortFilter" onchange="filterOrders()">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="highest">Highest Amount</option>
                    <option value="lowest">Lowest Amount</option>
                </select>
            </div>
            <div style="margin-left:auto;">
                <button onclick="clearFilters()" class="btn" style="padding:0.6rem 1.5rem;width:100%;">
                    Clear Filters
                </button>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="orders-table-wrapper">
            <div class="table-header">
                <div class="table-title">üì¶ All Orders</div>
                <button onclick="loadOrders()" class="btn" style="background:rgba(255,255,255,0.2);border:2px solid white;color:white;padding:0.6rem 1.5rem;">
                    Refresh
                </button>
            </div>
            <div id="ordersContainer" style="padding:2rem;">
                <div style="text-align:center;padding:2rem;">
                    <div class="loading-spinner"></div>
                    <p style="color:#6b7280;margin-top:1rem;">Loading orders...</p>
                </div>
            </div>
        </div>
    </div>

<footer style="background:#1f2937;color:white;padding:3rem 2rem;margin-top:4rem;">
    <div style="max-width:1400px;margin:0 auto;">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:3rem;margin-bottom:3rem;">
            <div>
                <h3 style="font-size:1.5rem;margin-bottom:1rem;font-weight:800;">üõí E-Commerce Store</h3>
                <p style="color:#9ca3af;line-height:1.6;">Your trusted online shopping destination for quality products at great prices.</p>
            </div>
            <div>
                <h4 style="font-size:1.1rem;margin-bottom:1rem;font-weight:700;">Quick Links</h4>
                <ul style="list-style:none;padding:0;">
                    <li style="margin-bottom:0.5rem;"><a href="/" style="color:#9ca3af;text-decoration:none;">Home</a></li>
                    <li style="margin-bottom:0.5rem;"><a href="/web/products" style="color:#9ca3af;text-decoration:none;">Products</a></li>
                    <li style="margin-bottom:0.5rem;"><a href="/web/orders" style="color:#9ca3af;text-decoration:none;">My Orders</a></li>
                    <li style="margin-bottom:0.5rem;"><a href="/web/profile" style="color:#9ca3af;text-decoration:none;">Profile</a></li>
                </ul>
            </div>
            <div>
                <h4 style="font-size:1.1rem;margin-bottom:1rem;font-weight:700;">Customer Service</h4>
                <ul style="list-style:none;padding:0;">
                    <li style="margin-bottom:0.5rem;"><a href="/web/contact" style="color:#9ca3af;text-decoration:none;">Contact Us</a></li>
                    <li style="margin-bottom:0.5rem;"><a href="/web/returns" style="color:#9ca3af;text-decoration:none;">Returns & Refunds</a></li>
                    <li style="margin-bottom:0.5rem;"><a href="/web/privacy" style="color:#9ca3af;text-decoration:none;">Privacy Policy</a></li>
                </ul>
            </div>
            <div>
                <h4 style="font-size:1.1rem;margin-bottom:1rem;font-weight:700;">Get in Touch</h4>
                <p style="color:#9ca3af;margin-bottom:0.5rem;">üìß support@ecommerce.com</p>
                <p style="color:#9ca3af;margin-bottom:0.5rem;">üì± 1-800-SHOP-NOW</p>
                <p style="color:#9ca3af;">üìç 123 Commerce St, City, State 12345</p>
            </div>
        </div>
        <div style="border-top:1px solid #374151;padding-top:2rem;text-align:center;">
            <p style="color:#9ca3af;margin-bottom:0.5rem;">¬© <span id="currentYear"></span> E-Commerce Store. All rights reserved.</p>
            <p style="color:#6b7280;font-size:0.9rem;">Powered by Stripe | Secure Shopping Experience</p>
        </div>
    </div>
</footer>

<script>
    document.getElementById('currentYear').textContent = new Date().getFullYear();
</script>

    <script>
    const user = JSON.parse(localStorage.getItem('user'));
    const token = localStorage.getItem('token');
    let allOrders = [];
    let filteredOrders = [];
    let allUsers = [];
    let orderToDelete = null;
    let currentLabelOrderId = null;
    let currentLabelBase64 = null;
    let uploadedLabelFile = null;
    let currentOrderForLabel = null; // Store entire order object


    console.log('üöÄ Admin Dashboard Loaded');

    if (!user || !token || user.role !== 'ADMIN') {
        alert('Admin access only!');
        window.location.href = '/web/login';
    }

    function updateCartCount() {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const count = cart.reduce((sum, item) => sum + item.quantity, 0);
        document.getElementById('cartCount').textContent = count;
    }

    function logout() {
        localStorage.clear();
        window.location.href = '/';
    }

    function initNavbar() {
        updateCartCount();
        
        if (user && token) {
            document.getElementById('userName').textContent = 'Hi, ' + user.name;
            document.getElementById('logoutBtn').style.display = 'block';
            document.getElementById('ordersLink').style.display = 'block';
            document.getElementById('profileLink').style.display = 'block';
            
            if (user.role === 'ADMIN') {
                document.getElementById('adminLink').style.display = 'block';
            }
        }
    }

    function toggleSection(sectionId) {
        const content = document.getElementById(sectionId);
        const toggle = document.getElementById(sectionId.replace('Section', 'Toggle'));
        
        if (content.classList.contains('show')) {
            content.classList.remove('show');
            toggle.classList.remove('expanded');
        } else {
            content.classList.add('show');
            toggle.classList.add('expanded');
            
            if (sectionId === 'shippingSection') {
                loadShippingConfig();
            } else if (sectionId === 'usersSection') {
                loadUsers();
            } else if (sectionId === 'returnedOrdersSection') {
                loadReturnedOrders();
            }
        }
    }

    function showCustomAlert(title, message, type = 'success', content = '') {
        const icon = document.getElementById('alertIcon');
        
        if (type === 'success') {
            icon.textContent = '‚úÖ';
            icon.style.color = '#10b981';
        } else {
            icon.textContent = '‚ùå';
            icon.style.color = '#ef4444';
        }
        
        document.getElementById('alertTitle').textContent = title;
        document.getElementById('alertMessage').textContent = message;
        document.getElementById('alertContent').innerHTML = content;
        document.getElementById('alertOverlay').classList.add('show');
        document.getElementById('customAlert').classList.add('show');
    }

    function closeCustomAlert() {
        document.getElementById('customAlert').classList.remove('show');
        document.getElementById('alertOverlay').classList.remove('show');
        document.getElementById('alertContent').innerHTML = '';
    }

    function clearFilters() {
        document.getElementById('orderIdSearch').value = '';
        document.getElementById('customerSearch').value = '';
        document.getElementById('statusFilter').value = 'all';
        document.getElementById('sortFilter').value = 'newest';
        filterOrders();
    }

    // ========== FILE UPLOAD HANDLING ==========
    
    function handleFileUpload(event) {
    const file = event.target.files[0];
    
    console.log('========================================');
    console.log('üìé FILE UPLOAD EVENT TRIGGERED');
    console.log('üìé File:', file);
    console.log('========================================');
    
    if (!file) {
        console.log('‚ö†Ô∏è No file selected');
        return;
    }
    
    // Validate file type
    if (file.type !== 'application/pdf') {
        showCustomAlert('Invalid File ‚ö†Ô∏è', 'Please upload a PDF file only', 'error');
        event.target.value = '';
        uploadedLabelFile = null;
        return;
    }
    
    // Validate file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
        showCustomAlert('File Too Large ‚ö†Ô∏è', 'Please upload a file smaller than 5MB', 'error');
        event.target.value = '';
        uploadedLabelFile = null;
        return;
    }
    
    uploadedLabelFile = file;
    
    console.log('‚úÖ File validated and stored');
    console.log('üìé File name:', file.name);
    console.log('üìé File size:', file.size, 'bytes');
    console.log('üìé File type:', file.type);
    
    // Update UI to show file is attached
    document.getElementById('uploadPrompt').style.display = 'none';
    document.getElementById('uploadedFile').style.display = 'block';
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileUploadArea').classList.add('has-file');
    
    console.log('‚úÖ UI updated - file attached successfully');
}

    // ========== RETURNED ORDERS FUNCTIONS ==========

    async function loadUsers() {
        try {
            document.getElementById('usersContainer').innerHTML = `
                <div style="text-align:center;padding:2rem;">
                    <div class="loading-spinner"></div>
                    <p style="color:#6b7280;margin-top:1rem;">Loading users...</p>
                </div>
            `;

            let response;
            let users = [];
            
            try {
                response = await fetch('/api/admin/users', {
                    headers: { 
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    users = await response.json();
                }
            } catch (e) {
                console.log('Primary endpoint failed, trying alternative...');
            }

            if (users.length === 0 && allOrders.length > 0) {
                console.log('üìã Extracting users from orders...');
                
                const userMap = new Map();
                allOrders.forEach(order => {
                    if (order.user && order.user.id) {
                        if (!userMap.has(order.user.id)) {
                            userMap.set(order.user.id, {
                                id: order.user.id,
                                name: order.user.name,
                                email: order.user.email,
                                role: order.user.role || 'USER',
                                createdAt: order.createdAt
                            });
                        }
                    }
                });
                
                users = Array.from(userMap.values());
            }

            allUsers = users;

            const adminCount = users.filter(u => u.role === 'ADMIN').length;
            const regularCount = users.filter(u => u.role === 'USER' || !u.role).length;
            
            document.getElementById('registeredUsersCount').textContent = users.length;
            document.getElementById('adminUsersCount').textContent = adminCount;
            document.getElementById('regularUsersCount').textContent = regularCount;

            if (users.length === 0) {
                document.getElementById('usersContainer').innerHTML = 
                    `<div class="empty-state">
                        <div style="font-size:4rem;opacity:0.5;margin-bottom:1rem;">üë•</div>
                        <h3 style="color:#1f2937;margin-bottom:0.5rem;">No Users Found</h3>
                        <p style="color:#6b7280;margin-bottom:1rem;">No registered users available</p>
                        <div style="background:#fef3c7;padding:1rem;border-radius:8px;border-left:4px solid #f59e0b;text-align:left;">
                            <p style="margin:0;color:#92400e;font-size:0.9rem;"><strong>‚ÑπÔ∏è Note:</strong> User data is extracted from orders. Users will appear here once they place orders.</p>
                        </div>
                    </div>`;
                return;
            }

            displayUsers(users);
        } catch (error) {
            console.error('Error loading users:', error);
            document.getElementById('usersContainer').innerHTML = 
                `<div class="empty-state">
                    <div style="font-size:3rem;color:#ef4444;margin-bottom:1rem;">‚ùå</div>
                    <h3 style="color:#1f2937;margin-bottom:0.5rem;">Error Loading Users</h3>
                    <p style="color:#6b7280;margin-bottom:1rem;">${error.message}</p>
                    <button onclick="loadUsers()" class="btn" style="margin-top:1rem;width:auto;padding:0.8rem 2rem;">üîÑ Retry</button>
                </div>`;
            
            if (allOrders.length > 0) {
                const userMap = new Map();
                allOrders.forEach(order => {
                    if (order.user && order.user.id) {
                        if (!userMap.has(order.user.id)) {
                            userMap.set(order.user.id, {
                                id: order.user.id,
                                name: order.user.name,
                                email: order.user.email,
                                role: order.user.role || 'USER',
                                createdAt: order.createdAt
                            });
                        }
                    }
                });
                
                const users = Array.from(userMap.values());
                if (users.length > 0) {
                    allUsers = users;
                    const adminCount = users.filter(u => u.role === 'ADMIN').length;
                    const regularCount = users.filter(u => u.role === 'USER' || !u.role).length;
                    
                    document.getElementById('registeredUsersCount').textContent = users.length;
                    document.getElementById('adminUsersCount').textContent = adminCount;
                    document.getElementById('regularUsersCount').textContent = regularCount;
                    
                    displayUsers(users);
                }
            }
        }
    }

    function displayUsers(users) {
        const html = `
            <div style="overflow-x:auto;">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Registered Date</th>
                            <th>Total Orders</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => {
                            const orderCount = allOrders.filter(o => o.user && o.user.id === user.id).length;
                            const registeredDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A';
                            
                            return `
                                <tr>
                                    <td data-label="User ID"><strong style="color:#667eea;">#${user.id}</strong></td>
                                    <td data-label="Name">
                                        <div style="font-weight:600;color:#1f2937;">${user.name}</div>
                                    </td>
                                    <td data-label="Email">
                                        <div style="color:#6b7280;word-break:break-all;">${user.email}</div>
                                    </td>
                                    <td data-label="Role">
                                        <span class="role-badge role-${user.role.toLowerCase()}">${user.role}</span>
                                    </td>
                                    <td data-label="Registered">
                                        <small style="color:#6b7280;">${registeredDate}</small>
                                    </td>
                                    <td data-label="Orders">
                                        <strong style="color:#10b981;">${orderCount}</strong>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;

        document.getElementById('usersContainer').innerHTML = html;
    }

    async function loadReturnedOrders() {
        try {
            document.getElementById('returnedOrdersContainer').innerHTML = `
                <div style="text-align:center;padding:2rem;">
                    <div class="loading-spinner"></div>
                    <p style="color:#6b7280;margin-top:1rem;">Loading returned orders...</p>
                </div>
            `;

            const response = await fetch('/api/admin/returned-orders', {
                headers: { 
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const returnedOrders = await response.json();
                
                // Filter out REFUND_ISSUED orders
                const activeReturns = returnedOrders.filter(order => {
                    const returnStatus = order.returnStatus || 'RETURN_REQUESTED';
                    return returnStatus !== 'REFUND_ISSUED';
                });
                
                document.getElementById('returnedOrdersCount').textContent = activeReturns.length;
                
                if (activeReturns.length === 0) {
                    document.getElementById('returnedOrdersContainer').innerHTML = 
                        `<div class="empty-state">
                            <div style="font-size:4rem;opacity:0.5;margin-bottom:1rem;">üîÑ</div>
                            <h3 style="color:#1f2937;margin-bottom:0.5rem;">No Active Returns</h3>
                            <p style="color:#6b7280;">No pending return requests at the moment</p>
                        </div>`;
                    return;
                }
                
                displayReturnedOrders(activeReturns);
            }
        } catch (error) {
            console.error('Error loading returned orders:', error);
            document.getElementById('returnedOrdersContainer').innerHTML = 
                `<div class="empty-state">
                    <div style="font-size:3rem;color:#ef4444;margin-bottom:1rem;">‚ùå</div>
                    <h3 style="color:#1f2937;margin-bottom:0.5rem;">Error Loading Returned Orders</h3>
                    <p style="color:#6b7280;margin-bottom:1rem;">${error.message}</p>
                    <button onclick="loadReturnedOrders()" class="btn" style="margin-top:1rem;width:auto;padding:0.8rem 2rem;">üîÑ Retry</button>
                </div>`;
        }
    }

    function displayReturnedOrders(orders) {
        const html = `
            <div style="overflow-x:auto;">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Return Date</th>
                            <th>Return Status</th>
                            <th>Return Tracking</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${orders.map(order => {
                            const returnDate = order.returnRequestDate ? new Date(order.returnRequestDate).toLocaleDateString() : 'N/A';
                            const customerEmail = order.user ? order.user.email : 'N/A';
                            const returnStatus = order.returnStatus || 'RETURN_REQUESTED';
                            const returnTracking = order.returnTrackingNumber || '';
                            const isRefundIssued = returnStatus === 'REFUND_ISSUED';
                            const isLabelSent = returnStatus === 'LABEL_SENT';
                            
                            return `
                                <tr>
                                    <td data-label="Order ID"><strong style="color:#667eea;">#${order.id}</strong></td>
                                    <td data-label="Customer">
                                        <div style="font-weight:600;color:#1f2937;">${order.user ? order.user.name : 'N/A'}</div>
                                        <small style="color:#6b7280;word-break:break-all;">${customerEmail}</small>
                                    </td>
                                    <td data-label="Amount"><strong style="color:#f59e0b;">$${(order.totalAmount || 0).toFixed(2)}</strong></td>
                                    <td data-label="Return Date"><small style="color:#6b7280;">${returnDate}</small></td>
                                    <td data-label="Return Status">
                                        <select id="returnStatus_${order.id}" onchange="handleReturnStatusChange(${order.id})">
                                            <option value="RETURN_REQUESTED" ${returnStatus === 'RETURN_REQUESTED' ? 'selected' : ''}>Return Requested</option>
                                            <option value="LABEL_SENT" ${returnStatus === 'LABEL_SENT' ? 'selected' : ''}>Label Sent</option>
                                            <option value="IN_TRANSIT" ${returnStatus === 'IN_TRANSIT' ? 'selected' : ''}>In Transit</option>
                                            <option value="RECEIVED" ${returnStatus === 'RECEIVED' ? 'selected' : ''}>Received</option>
                                            <option value="REFUND_ISSUED" ${returnStatus === 'REFUND_ISSUED' ? 'selected' : ''}>Refund Issued</option>
                                        </select>
                                    </td>
                                    <td data-label="Return Tracking">
                                        <input 
                                            type="text" 
                                            id="returnTracking_${order.id}" 
                                            value="${returnTracking}" 
                                            placeholder="${isLabelSent ? 'Enter tracking #' : 'Read-only'}"
                                            ${!isLabelSent ? 'disabled' : ''}
                                            style="width:100%;background:${isLabelSent ? '#dbeafe' : '#f3f4f6'};
                                                   border-color:${isLabelSent ? '#3b82f6' : '#e5e7eb'};
                                                   color:${isLabelSent ? '#1e40af' : '#9ca3af'};"
                                        >
                                    </td>
                                    <td data-label="Actions">
                                        <button onclick="updateReturnTracking(${order.id})" class="action-btn btn-update">
                                            Update Status
                                        </button>
                                        <button onclick="openLabelModal(${order.id})" class="action-btn" style="background:#8b5cf6;color:white;">
                                            View/Attach Label
                                        </button>
                                        <button onclick="sendLabelQuick(${order.id})" class="action-btn" style="background:#06b6d4;color:white;">
                                            Send Label
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;

        document.getElementById('returnedOrdersContainer').innerHTML = html;
    }
    
    function handleReturnStatusChange(orderId) {
        const statusSelect = document.getElementById('returnStatus_' + orderId);
        const trackingInput = document.getElementById('returnTracking_' + orderId);
        
        if (!statusSelect || !trackingInput) return;
        
        const status = statusSelect.value;
        
        console.log('Return status changed for order', orderId, 'to', status);
        
        // Only LABEL_SENT status allows editing tracking number
        if (status === 'LABEL_SENT') {
            trackingInput.disabled = false;
            trackingInput.style.background = '#dbeafe';
            trackingInput.style.borderColor = '#3b82f6';
            trackingInput.style.color = '#1e40af';
            trackingInput.placeholder = 'Enter tracking # (required)';
            
            if (!trackingInput.value) {
                setTimeout(() => trackingInput.focus(), 100);
            }
        } else {
            // All other statuses: tracking field is READ-ONLY
            trackingInput.disabled = true;
            
            // Different styling based on status
            if (status === 'REFUND_ISSUED') {
                trackingInput.style.background = '#d1fae5';
                trackingInput.style.borderColor = '#10b981';
                trackingInput.style.color = '#065f46';
            } else if (status === 'IN_TRANSIT') {
                trackingInput.style.background = '#fef3c7';
                trackingInput.style.borderColor = '#f59e0b';
                trackingInput.style.color = '#92400e';
            } else if (status === 'RECEIVED') {
                trackingInput.style.background = '#d1fae5';
                trackingInput.style.borderColor = '#10b981';
                trackingInput.style.color = '#065f46';
            } else {
                trackingInput.style.background = '#f3f4f6';
                trackingInput.style.borderColor = '#e5e7eb';
                trackingInput.style.color = '#9ca3af';
            }
            
            trackingInput.placeholder = 'Read-only';
        }
    }
    
    async function updateReturnTracking(orderId) {
        console.log('updateReturnTracking called for order:', orderId);
        
        const returnTrackingInput = document.getElementById('returnTracking_' + orderId);
        const returnStatusSelect = document.getElementById('returnStatus_' + orderId);
        
        if (!returnTrackingInput || !returnStatusSelect) {
            console.error('Could not find elements for order:', orderId);
            showCustomAlert('Error', 'Could not find return tracking elements', 'error');
            return;
        }
        
        const returnTrackingNumber = returnTrackingInput.value.trim();
        const returnStatus = returnStatusSelect.value;
        
        console.log('Return Status:', returnStatus);
        console.log('Return Tracking:', returnTrackingNumber);
        
        // Only require tracking number when status is LABEL_SENT
        if (returnStatus === 'LABEL_SENT' && !returnTrackingNumber) {
            showCustomAlert('Tracking Required ‚ö†Ô∏è', 'Please enter a return tracking number for Label Sent status', 'error');
            returnTrackingInput.focus();
            return;
        }
        
        // Confirmation for REFUND_ISSUED
        if (returnStatus === 'REFUND_ISSUED') {
            const order = allOrders.find(o => o.id === orderId);
            const confirmRefund = confirm(
                `Issue refund of $${order.totalAmount.toFixed(2)} for Order #${orderId}?\n\n` +
                `This will:\n` +
                `- Update order status to REFUND_ISSUED\n` +
                `- Send confirmation email to customer\n` +
                `- Remove order from Returns section\n\n` +
                `This action cannot be undone!`
            );
            
            if (!confirmRefund) {
                // Reset the dropdown to previous value
                const currentOrder = allOrders.find(o => o.id === orderId);
                if (currentOrder && currentOrder.returnStatus) {
                    returnStatusSelect.value = currentOrder.returnStatus;
                }
                return;
            }
        }
        
        try {
            showCustomAlert('Updating...', 'Updating return status', 'success');
            
            // Determine if tracking details should be included in email
            const includeTracking = (returnStatus === 'LABEL_SENT' && returnTrackingNumber);
            
            console.log('Include tracking in email:', includeTracking);
            
            const response = await fetch(`/api/admin/orders/${orderId}/return-tracking`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({
                    returnTrackingNumber: returnTrackingNumber || null,
                    returnStatus: returnStatus,
                    includeTracking: includeTracking
                })
            });
            
            console.log('Response status:', response.status);
            
            if (response.ok) {
                const result = await response.json();
                console.log('Update result:', result);
                closeCustomAlert();
                
                let message = `Return status updated to ${returnStatus}!`;
                if (returnStatus === 'REFUND_ISSUED') {
                    message = `Refund of $${result.refundAmount ? result.refundAmount.toFixed(2) : '0.00'} has been issued! Confirmation email sent to customer.`;
                } else if (includeTracking) {
                    message += ` Tracking email sent to customer. Carrier: ${result.carrier || 'USPS'}`;
                } else {
                    message += ` Status update email sent to customer.`;
                }
                
                showCustomAlert('Updated! ‚úÖ', message, 'success');
                
                // Reload both returned orders and all orders
                loadReturnedOrders();
                loadOrders();
                
            } else {
                const errorText = await response.text();
                console.error('Error response:', errorText);
                closeCustomAlert();
                showCustomAlert('Error', 'Failed to update return tracking: ' + errorText, 'error');
            }
        } catch (error) {
            console.error('Exception in updateReturnTracking:', error);
            closeCustomAlert();
            showCustomAlert('Error', 'Error updating tracking: ' + error.message, 'error');
        }
    }

    async function issueRefund(orderId) {
        const order = allOrders.find(o => o.id === orderId);
        if (!order) {
            showCustomAlert('Error', 'Order not found', 'error');
            return;
        }
        
        // Confirmation dialog
        if (!confirm(`Issue refund of $${order.totalAmount.toFixed(2)} for Order #${orderId}?\n\nThis will send a confirmation email to the customer.`)) {
            return;
        }
        
        try {
            showCustomAlert('Processing...', 'Issuing refund and sending confirmation email', 'success');
            
            const response = await fetch(`/api/admin/orders/${orderId}/issue-refund`, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                closeCustomAlert();
                showCustomAlert(
                    'Refund Issued! ‚úÖ', 
                    `Refund of $${result.refundAmount.toFixed(2)} has been issued. Customer notified via email.`, 
                    'success'
                );
                loadReturnedOrders();
                loadOrders();
            } else {
                closeCustomAlert();
                showCustomAlert('Error', 'Failed to issue refund', 'error');
            }
        } catch (error) {
            closeCustomAlert();
            showCustomAlert('Error', 'Error issuing refund: ' + error.message, 'error');
        }
    }

    async function openLabelModal(orderId) {
        try {
            // Find the order from allOrders array
            const order = allOrders.find(o => o.id === orderId);
            
            if (!order) {
                showCustomAlert('Error', 'Order not found', 'error');
                return;
            }
            
            currentLabelOrderId = orderId;
            currentOrderForLabel = order;
            uploadedLabelFile = null;
            currentLabelBase64 = null;
            
            const customerEmail = order.user ? order.user.email : 'Unknown';
            const customerName = order.user ? order.user.name : 'Unknown';
            
            console.log('========================================');
            console.log('üì¶ Opening label modal for Order #' + orderId);
            console.log('üë§ Customer:', customerName);
            console.log('üìß Customer email:', customerEmail);
            console.log('========================================');
            
            // Reset file upload UI
            document.getElementById('uploadPrompt').style.display = 'block';
            document.getElementById('uploadedFile').style.display = 'none';
            document.getElementById('fileUploadArea').classList.remove('has-file');
            document.getElementById('labelFileInput').value = '';
            
            // Show modal with loading state
            document.getElementById('labelOrderId').textContent = orderId;
            document.getElementById('labelCustomerEmail').textContent = customerEmail;
            document.getElementById('labelPreviewContent').innerHTML = `
                <div style="text-align:center;padding:3rem;">
                    <div class="loading-spinner"></div>
                    <p style="color:#6b7280;margin-top:1rem;">Generating USPS-style shipping label...</p>
                </div>
            `;
            document.getElementById('labelOverlay').classList.add('show');
            document.getElementById('labelPreviewModal').classList.add('show');
            
            const response = await fetch(`/api/admin/orders/${orderId}/preview-label`, {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            
            if (response.ok) {
                const result = await response.json();
                currentLabelBase64 = result.labelBase64;
                
                // Display PDF in iframe
                document.getElementById('labelPreviewContent').innerHTML = `
                    <iframe src="data:application/pdf;base64,${result.labelBase64}" 
                            style="width:100%;height:600px;border:none;"></iframe>
                `;
                
                console.log('‚úÖ Label preview loaded successfully');
            } else {
                currentLabelBase64 = null;
                document.getElementById('labelPreviewContent').innerHTML = `
                    <div style="text-align:center;padding:3rem;">
                        <div style="font-size:3rem;color:#ef4444;margin-bottom:1rem;">‚ùå</div>
                        <h3 style="color:#1f2937;">Failed to Generate Label</h3>
                        <p style="color:#6b7280;">You can still attach a custom label above</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error generating label:', error);
            document.getElementById('labelPreviewContent').innerHTML = `
                <div style="text-align:center;padding:3rem;">
                    <div style="font-size:3rem;color:#ef4444;margin-bottom:1rem;">‚ùå</div>
                    <h3 style="color:#1f2937;">Error</h3>
                    <p style="color:#6b7280;">${error.message}</p>
                    <p style="color:#6b7280;margin-top:1rem;">You can still attach a custom label above</p>
                </div>
            `;
        }
    }

    function closeLabelPreview() {
        console.log('üîí Closing label preview modal');
        
        document.getElementById('labelPreviewModal').classList.remove('show');
        document.getElementById('labelOverlay').classList.remove('show');
        
        currentLabelOrderId = null;
        currentLabelBase64 = null;
        uploadedLabelFile = null;
        currentOrderForLabel = null;
        
        // Reset file input
        const fileInput = document.getElementById('labelFileInput');
        if (fileInput) fileInput.value = '';
        
        document.getElementById('uploadPrompt').style.display = 'block';
        document.getElementById('uploadedFile').style.display = 'none';
        document.getElementById('fileUploadArea').classList.remove('has-file');
        
        console.log('‚úÖ Label modal closed and all variables reset');
    }

    async function downloadCurrentLabel() {
        if (!currentLabelBase64 && !uploadedLabelFile) {
            showCustomAlert('Error', 'No label to download', 'error');
            return;
        }
        
        try {
            if (uploadedLabelFile) {
                // Download the uploaded file
                const url = URL.createObjectURL(uploadedLabelFile);
                const a = document.createElement('a');
                a.href = url;
                a.download = uploadedLabelFile.name;
                document.body.appendChild(a);
                a.click();
                URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showCustomAlert('Downloaded! ‚úÖ', `Your custom label has been downloaded`, 'success');
            } else {
                // Download the generated label
                const byteCharacters = atob(currentLabelBase64);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'application/pdf' });
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `USPS_Return_Label_Order_${currentLabelOrderId}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showCustomAlert('Downloaded! ‚úÖ', `Label for Order #${currentLabelOrderId} has been downloaded`, 'success');
            }
        } catch (error) {
            showCustomAlert('Error', 'Failed to download: ' + error.message, 'error');
        }
    }

    async function sendCurrentLabel() {
        console.log('========================================');
        console.log('üöÄ SEND CURRENT LABEL FUNCTION CALLED');
        console.log('üì¶ Order ID:', currentLabelOrderId);
        console.log('üìß Order Object:', currentOrderForLabel);
        console.log('üìé Uploaded File:', uploadedLabelFile);
        console.log('üìÑ Generated Label Base64:', currentLabelBase64 ? 'Available' : 'Not available');
        console.log('========================================');
        
        if (!currentLabelOrderId || !currentOrderForLabel) {
            showCustomAlert('Error', 'No order selected', 'error');
            return;
        }
        
        const customerEmail = currentOrderForLabel.user ? currentOrderForLabel.user.email : null;
        const customerName = currentOrderForLabel.user ? currentOrderForLabel.user.name : 'Customer';
        
        if (!customerEmail) {
            showCustomAlert('Error', 'Customer email not found', 'error');
            return;
        }
        
        if (!uploadedLabelFile && !currentLabelBase64) {
            showCustomAlert('Error', 'No label available to send. Please generate or attach a label first.', 'error');
            return;
        }
        
        try {
            const sendBtn = document.getElementById('sendLabelBtn');
            const originalText = sendBtn.innerHTML;
            sendBtn.disabled = true;
            
            // Check which label to send - UPLOADED FILE HAS PRIORITY
            if (uploadedLabelFile && uploadedLabelFile instanceof File) {
                console.log('========================================');
                console.log('üìé SENDING CUSTOM UPLOADED LABEL');
                console.log('üìé File name:', uploadedLabelFile.name);
                console.log('üìé File size:', uploadedLabelFile.size, 'bytes');
                console.log('üìé File type:', uploadedLabelFile.type);
                console.log('üìß Sending to:', customerEmail);
                console.log('========================================');
                
                sendBtn.innerHTML = 'üìß Sending Custom Label...';
                
                // Create FormData and append file
                const formData = new FormData();
                formData.append('labelFile', uploadedLabelFile);
                
                console.log('üì§ FormData created, sending request...');
                
                const response = await fetch(`/api/admin/orders/${currentLabelOrderId}/send-custom-label`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': 'Bearer ' + token
                    },
                    body: formData
                });
                
                console.log('üì• Response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = originalText;
                    
                    console.log('‚úÖ SUCCESS! Custom label sent');
                    console.log('‚úÖ Response:', result);
                    
                    closeLabelPreview();
                    
                    showCustomAlert(
                        'Custom Label Sent! ‚úÖ', 
                        `Your custom label has been sent to ${customerEmail}`, 
                        'success'
                    );
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Error response:', errorText);
                    
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch (e) {
                        errorData = { error: errorText || 'Unknown error' };
                    }
                    
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = originalText;
                    
                    showCustomAlert('Error', errorData.error || 'Failed to send custom label', 'error');
                }
            } else if (currentLabelBase64) {
                console.log('========================================');
                console.log('üìÑ SENDING AUTO-GENERATED LABEL');
                console.log('üìß Sending to:', customerEmail);
                console.log('========================================');
                
                sendBtn.innerHTML = 'üìß Sending Generated Label...';
                
                // Send generated label
                const response = await fetch(`/api/admin/orders/${currentLabelOrderId}/send-label`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = originalText;
                    
                    console.log('‚úÖ Generated label sent successfully');
                    
                    closeLabelPreview();
                    
                    showCustomAlert('Label Sent! ‚úÖ', `Generated label sent to ${customerEmail}`, 'success');
                } else {
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = originalText;
                    showCustomAlert('Error', 'Failed to send shipping label', 'error');
                }
            } else {
                sendBtn.disabled = false;
                sendBtn.innerHTML = originalText;
                showCustomAlert('Error', 'No label available. Please attach a file or wait for generation.', 'error');
            }
        } catch (error) {
            console.error('========================================');
            console.error('‚ùå CRITICAL ERROR SENDING LABEL');
            console.error('Error:', error);
            console.error('Stack:', error.stack);
            console.error('========================================');
            
            const sendBtn = document.getElementById('sendLabelBtn');
            if (sendBtn) {
                sendBtn.disabled = false;
                sendBtn.innerHTML = 'üìß Send to Customer';
            }
            showCustomAlert('Error', 'Error sending label: ' + error.message, 'error');
        }
    }
    
    async function sendLabelQuick(orderId) {
        const order = allOrders.find(o => o.id === orderId);
        if (!order) {
            showCustomAlert('Error', 'Order not found', 'error');
            return;
        }
        
        const customerEmail = order.user ? order.user.email : null;
        
        if (!customerEmail) {
            showCustomAlert('Error', 'Customer email not found', 'error');
            return;
        }
        
        try {
            showCustomAlert('Sending...', 'Generating and sending shipping label to ' + customerEmail, 'success');
            
            const response = await fetch(`/api/admin/orders/${orderId}/send-label`, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            
            if (response.ok) {
                const result = await response.json();
                closeCustomAlert();
                showCustomAlert('Label Sent! ‚úÖ', `Generated shipping label sent to ${customerEmail}`, 'success');
            } else {
                closeCustomAlert();
                showCustomAlert('Error', 'Failed to send shipping label', 'error');
            }
        } catch (error) {
            closeCustomAlert();
            showCustomAlert('Error', 'Error sending label: ' + error.message, 'error');
        }
    }

    async function sendLabel(orderId) {
        try {
            showCustomAlert('Sending...', 'Generating and sending shipping label via email', 'success');
            
            const response = await fetch(`/api/admin/orders/${orderId}/send-label`, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            
            if (response.ok) {
                const result = await response.json();
                closeCustomAlert();
                showCustomAlert('Label Sent! ‚úÖ', result.message, 'success');
            } else {
                closeCustomAlert();
                showCustomAlert('Error', 'Failed to send shipping label', 'error');
            }
        } catch (error) {
            closeCustomAlert();
            showCustomAlert('Error', 'Error sending label: ' + error.message, 'error');
        }
    }

    function detectCarrier(trackingNumber) {
        if (!trackingNumber) return 'USPS';
        
        const tracking = trackingNumber.trim().toUpperCase().replace(/\s+/g, '');
        
        if (tracking.match(/^1Z[A-Z0-9]{16}$/)) return 'UPS';
        if (tracking.match(/^T\d{10}$/)) return 'UPS';
        if (tracking.match(/^\d{18}$/)) return 'UPS';
        if (tracking.match(/^(94|92|93|82|71|61|42|41|40|23|03|02|01)\d{18,24}$/)) return 'USPS';
        if (tracking.match(/^[A-Z]{2}\d{9}US$/)) return 'USPS';
        if (tracking.match(/^\d{12}$/) && !tracking.match(/^(94|92|93|82|71|61|42|41|40|23|03|02|01)/)) return 'FedEx';
        
        const length = tracking.length;
        if (tracking.match(/^\d+$/) && [14, 15, 20, 22].includes(length)) return 'FedEx';
        if (tracking.match(/^(96|02|03|04|05|06|07|08|09)\d{10,20}$/)) return 'FedEx';
        if (tracking.match(/^\d{10,11}$/) && !tracking.match(/^(94|92|93|82|71|61|42|41|40|23|03|02|01)/)) return 'DHL';
        if (tracking.match(/^(JJD|JVGL|GM|LX|RX)\d{10,20}$/)) return 'DHL';
        if (tracking.match(/^TBA\d{12,13}$/)) return 'Amazon Logistics';
        
        return 'USPS';
    }

    function getTrackingUrl(trackingNumber, carrier) {
        if (!trackingNumber) return '#';
        
        switch (carrier.toUpperCase()) {
            case 'UPS': return `https://www.ups.com/track?tracknum=${trackingNumber}`;
            case 'FEDEX': return `https://www.fedex.com/fedextrack/?trknbr=${trackingNumber}`;
            case 'DHL': return `https://www.dhl.com/en/express/tracking.html?AWB=${trackingNumber}`;
            case 'USPS': return `https://tools.usps.com/go/TrackConfirmAction?tLabels=${trackingNumber}`;
            case 'AMAZON LOGISTICS': return `https://track.amazon.com/tracking/${trackingNumber}`;
            default: return `https://tools.usps.com/go/TrackConfirmAction?tLabels=${trackingNumber}`;
        }
    }

    function filterOrders() {
        const orderIdSearch = document.getElementById('orderIdSearch').value.trim().toLowerCase();
        const customerSearch = document.getElementById('customerSearch').value.trim().toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const sortFilter = document.getElementById('sortFilter').value;

        let filtered = [...allOrders];

        if (orderIdSearch) {
            filtered = filtered.filter(order => order.id.toString().includes(orderIdSearch));
        }

        if (customerSearch) {
            filtered = filtered.filter(order => {
                const customerName = order.user ? order.user.name.toLowerCase() : '';
                const customerEmail = order.user ? order.user.email.toLowerCase() : '';
                return customerName.includes(customerSearch) || customerEmail.includes(customerSearch);
            });
        }

        if (statusFilter !== 'all') {
            filtered = filtered.filter(order => {
                const orderStatus = order.orderStatus || order.status || 'PENDING';
                return orderStatus === statusFilter;
            });
        }

        if (sortFilter === 'newest') {
            filtered.sort((a, b) => new Date(b.orderDate || b.createdAt) - new Date(a.orderDate || a.createdAt));
        } else if (sortFilter === 'oldest') {
            filtered.sort((a, b) => new Date(a.orderDate || a.createdAt) - new Date(b.orderDate || b.createdAt));
        } else if (sortFilter === 'highest') {
            filtered.sort((a, b) => (b.totalAmount || 0) - (a.totalAmount || 0));
        } else if (sortFilter === 'lowest') {
            filtered.sort((a, b) => (a.totalAmount || 0) - (b.totalAmount || 0));
        }

        filteredOrders = filtered;
        displayOrders(filtered);
    }

    async function loadStats() {
        try {
            const response = await fetch('/api/admin/stats', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            
            if (response.ok) {
                const stats = await response.json();
                document.getElementById('totalOrders').textContent = stats.totalOrders || 0;
                document.getElementById('totalUsers').textContent = stats.totalUsers || 0;
                document.getElementById('totalProducts').textContent = stats.totalProducts || 0;
                document.getElementById('totalRevenue').textContent = (stats.totalRevenue || 0).toFixed(2);
            }
        } catch (error) {
            console.error('‚ùå Error loading stats:', error);
        }
    }

    async function loadOrders() {
        try {
            document.getElementById('ordersContainer').innerHTML = `
                <div style="text-align:center;padding:2rem;">
                    <div class="loading-spinner"></div>
                    <p style="color:#6b7280;margin-top:1rem;">Loading orders...</p>
                </div>
            `;

            const response = await fetch('/api/admin/orders', {
                headers: { 
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                document.getElementById('ordersContainer').innerHTML = 
                    `<div class="empty-state">
                        <div style="font-size:3rem;color:#ef4444;margin-bottom:1rem;">‚ùå</div>
                        <h3 style="color:#1f2937;margin-bottom:0.5rem;">Failed to Load Orders</h3>
                        <p style="color:#6b7280;margin-bottom:1.5rem;">Status: ${response.status}</p>
                        <button onclick="loadOrders()" class="btn">üîÑ Retry</button>
                    </div>`;
                return;
            }

            const orders = await response.json();
            allOrders = orders;
            filteredOrders = orders;

            if (orders.length === 0) {
                document.getElementById('filtersSection').style.display = 'none';
                document.getElementById('ordersContainer').innerHTML = 
                    `<div class="empty-state">
                        <div style="font-size:4rem;opacity:0.5;margin-bottom:1rem;">üì¶</div>
                        <h3 style="color:#1f2937;margin-bottom:0.5rem;">No Orders Yet</h3>
                        <p style="color:#6b7280;">Orders will appear here once customers start purchasing</p>
                    </div>`;
                return;
            }

            document.getElementById('filtersSection').style.display = 'flex';
            displayOrders(orders);
        } catch (error) {
            document.getElementById('ordersContainer').innerHTML = 
                `<div class="empty-state">
                    <div style="font-size:3rem;color:#ef4444;margin-bottom:1rem;">‚ùå</div>
                    <h3 style="color:#1f2937;margin-bottom:0.5rem;">Error Loading Orders</h3>
                    <p style="color:#6b7280;margin-bottom:1.5rem;">${error.message}</p>
                    <button onclick="loadOrders()" class="btn">üîÑ Retry</button>
                </div>`;
        }
    }

    function displayOrders(orders) {
        if (orders.length === 0) {
            document.getElementById('ordersContainer').innerHTML = 
                `<div class="empty-state">
                    <div style="font-size:3rem;opacity:0.5;margin-bottom:1rem;">üîç</div>
                    <h3 style="color:#1f2937;margin-bottom:0.5rem;">No Orders Found</h3>
                    <p style="color:#6b7280;margin-bottom:1.5rem;">Try adjusting your filters</p>
                    <button onclick="clearFilters()" class="btn">Clear Filters</button>
                </div>`;
            return;
        }

        const html = `
            <div style="overflow-x:auto;">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Payment</th>
                            <th>Order Status</th>
                            <th>Tracking Number</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${orders.map(order => {
                            const orderStatus = order.orderStatus || order.status || 'PENDING';
                            const paymentStatus = order.paymentStatus || 'PENDING';
                            const isReturned = orderStatus === 'RETURNED';
                            const returnStatus = order.returnStatus || null;
                            
                            // Build return notice based on actual return status
                            let returnNotice = '';
                            if (isReturned && returnStatus) {
                                let statusText = returnStatus.replace(/_/g, ' ');
                                let statusColor = '#fef3c7';
                                let textColor = '#92400e';
                                
                                if (returnStatus === 'REFUND_ISSUED') {
                                    statusColor = '#d1fae5';
                                    textColor = '#065f46';
                                    statusText = '‚úÖ REFUND ISSUED';
                                } else if (returnStatus === 'LABEL_SENT') {
                                    statusColor = '#dbeafe';
                                    textColor = '#1e40af';
                                    statusText = 'üìß LABEL SENT';
                                } else if (returnStatus === 'IN_TRANSIT') {
                                    statusColor = '#fef3c7';
                                    textColor = '#f59e0b';
                                    statusText = 'üöö IN TRANSIT';
                                } else if (returnStatus === 'RECEIVED') {
                                    statusColor = '#d1fae5';
                                    textColor = '#059669';
                                    statusText = 'üì¶ RECEIVED';
                                } else if (returnStatus === 'RETURN_REQUESTED') {
                                    statusText = 'üîÑ RETURN REQUESTED';
                                }
                                
                                returnNotice = `
                                    <div class="return-notice" style="background:${statusColor};color:${textColor};border-left-color:${textColor};">
                                        ${statusText}
                                    </div>
                                `;
                            } else if (isReturned) {
                                returnNotice = `
                                    <div class="return-notice">
                                        üîÑ Return requested by customer
                                    </div>
                                `;
                            }
                            
                            return `
                                <tr>
                                    <td data-label="Order ID"><strong style="color:#667eea;">#${order.id}</strong></td>
                                    <td data-label="Customer">
                                        <div style="font-weight:600;color:#1f2937;">${order.user ? order.user.name : 'N/A'}</div>
                                        <small style="color:#6b7280;word-break:break-all;">${order.user ? order.user.email : 'N/A'}</small>
                                    </td>
                                    <td data-label="Amount"><strong style="color:#10b981;">$${(order.totalAmount || 0).toFixed(2)}</strong></td>
                                    <td data-label="Payment"><span class="order-status status-${paymentStatus.toLowerCase()}">${paymentStatus}</span></td>
                                    <td data-label="Status">
                                        <select id="status_${order.id}" onchange="handleStatusChange(${order.id})" ${isReturned ? 'disabled' : ''}>
                                            <option value="PENDING" ${orderStatus === 'PENDING' ? 'selected' : ''}>Pending</option>
                                            <option value="PROCESSING" ${orderStatus === 'PROCESSING' ? 'selected' : ''}>Processing</option>
                                            <option value="SHIPPED" ${orderStatus === 'SHIPPED' ? 'selected' : ''}>Shipped</option>
                                            <option value="DELIVERED" ${orderStatus === 'DELIVERED' ? 'selected' : ''}>Delivered</option>
                                            <option value="CANCELLED" ${orderStatus === 'CANCELLED' ? 'selected' : ''}>Cancelled</option>
                                            <option value="RETURNED" ${orderStatus === 'RETURNED' ? 'selected' : ''}>Returned</option>
                                        </select>
                                        ${returnNotice}
                                    </td>
                                    <td data-label="Tracking">
                                    <div style="position:relative;width:100%;">
                                        <input 
                                            type="text" 
                                            id="tracking_${order.id}" 
                                            value="${order.trackingNumber || ''}" 
                                            placeholder="${orderStatus === 'SHIPPED' ? 'Enter tracking #' : 'N/A'}"
                                            ${orderStatus !== 'SHIPPED' && !isReturned ? 'disabled' : ''}
                                            ${isReturned ? 'disabled' : ''}
                                            style="width:100%;
                                                   padding:0.7rem 2.5rem 0.7rem 0.9rem;
                                                   border:2px solid ${orderStatus === 'SHIPPED' ? '#3b82f6' : '#e5e7eb'};
                                                   border-radius:8px;
                                                   font-family:'Courier New', monospace;
                                                   font-size:0.85rem;
                                                   font-weight:600;
                                                   background:${orderStatus === 'SHIPPED' ? '#dbeafe' : '#f9fafb'};
                                                   color:${orderStatus === 'SHIPPED' ? '#1e40af' : '#9ca3af'};
                                                   transition:all 0.3s ease;
                                                   letter-spacing:0.5px;"
                                            onfocus="this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.2)'; this.style.borderColor='#3b82f6';"
                                            onblur="this.style.boxShadow='none'; this.style.borderColor='${orderStatus === 'SHIPPED' ? '#3b82f6' : '#e5e7eb'}';"
                                        >
                                        ${orderStatus === 'SHIPPED' && order.trackingNumber ? `
                                            <div style="position:absolute;right:8px;top:50%;transform:translateY(-50%);pointer-events:none;">
                                                <span style="color:#10b981;font-size:1.2rem;">‚úì</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div id="trackingStatus_${order.id}" style="margin-top:0.3rem;font-size:0.7rem;text-align:center;"></div>
                                </td>
                                    <td data-label="Date"><small style="color:#6b7280;">${new Date(order.orderDate || order.createdAt).toLocaleDateString()}</small></td>
                                    <td data-label="Actions">
                                        <button onclick="viewOrderDetails(${order.id})" class="action-btn btn-view">View</button>
                                        <button onclick="updateOrderClick(${order.id})" class="action-btn btn-update" ${isReturned ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>Update</button>
                                        <button onclick="confirmDeleteOrder(${order.id})" class="action-btn btn-delete">Delete</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;

        document.getElementById('ordersContainer').innerHTML = html;
        orders.forEach(order => handleStatusChange(order.id));
    }

    function confirmDeleteOrder(orderId) {
        const order = allOrders.find(o => o.id === orderId);
        if (!order) {
            showCustomAlert('Error', 'Order not found', 'error');
            return;
        }
                orderToDelete = orderId;
        document.getElementById('deleteOrderId').textContent = orderId;
        document.getElementById('deleteCustomerName').textContent = order.user ? order.user.name : 'N/A';
        document.getElementById('deleteOverlay').classList.add('show');
        document.getElementById('deleteConfirmModal').classList.add('show');
    }

    function closeDeleteConfirm() {
        document.getElementById('deleteConfirmModal').classList.remove('show');
        document.getElementById('deleteOverlay').classList.remove('show');
        orderToDelete = null;
    }

    async function deleteOrderConfirmed() {
        if (!orderToDelete) return;
        
        try {
            const response = await fetch(`/api/admin/orders/${orderToDelete}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            });

            if (response.ok || response.status === 204) {
                closeDeleteConfirm();
                showCustomAlert('Order Deleted ‚úÖ', `Order #${orderToDelete} has been permanently deleted`, 'success');
                loadOrders();
                loadStats();
            } else {
                closeDeleteConfirm();
                showCustomAlert('Delete Failed', 'Failed to delete order', 'error');
            }
        } catch (error) {
            closeDeleteConfirm();
            showCustomAlert('Error', 'Error deleting order: ' + error.message, 'error');
        }
    }

    async function loadShippingConfig() {
        try {
            const response = await fetch('/api/admin/shipping', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            
            if (response.ok) {
                const config = await response.json();
                document.getElementById('currentShippingCost').textContent = config.shippingCost.toFixed(2);
                document.getElementById('currentThreshold').textContent = config.freeShippingThreshold.toFixed(2);
                document.getElementById('shippingCost').value = config.shippingCost;
                document.getElementById('freeShippingThreshold').value = config.freeShippingThreshold;
            }
        } catch (error) {
            console.error('Error loading shipping config:', error);
        }
    }

    function handleStatusChange(orderId) {
        const statusSelect = document.getElementById('status_' + orderId);
        const trackingInput = document.getElementById('tracking_' + orderId);
        
        if (!statusSelect || !trackingInput) return;
        
        const status = statusSelect.value;
        
        // Disable editing for RETURNED orders
        if (status === 'RETURNED') {
            trackingInput.disabled = true;
            statusSelect.disabled = true;
            trackingInput.style.background = '#fef3c7';
            trackingInput.style.borderColor = '#f59e0b';
            trackingInput.style.color = '#92400e';
            return;
        }
        
        // Only SHIPPED status allows editing tracking number
        if (status === 'SHIPPED') {
            trackingInput.disabled = false;
            trackingInput.style.background = '#dbeafe';
            trackingInput.style.borderColor = '#3b82f6';
            trackingInput.style.color = '#1e40af';
            trackingInput.placeholder = 'Enter tracking # (required)';
            
            if (!trackingInput.value) {
                setTimeout(() => trackingInput.focus(), 100);
            }
        } else {
            // All other statuses: tracking field is READ-ONLY
            trackingInput.disabled = true;
            
            // Different styling based on status
            if (status === 'DELIVERED') {
                trackingInput.style.background = '#d1fae5';
                trackingInput.style.borderColor = '#10b981';
                trackingInput.style.color = '#065f46';
            } else if (status === 'PROCESSING') {
                trackingInput.style.background = '#fef3c7';
                trackingInput.style.borderColor = '#f59e0b';
                trackingInput.style.color = '#92400e';
            } else if (status === 'CANCELLED') {
                trackingInput.style.background = '#fee2e2';
                trackingInput.style.borderColor = '#ef4444';
                trackingInput.style.color = '#991b1b';
            } else {
                trackingInput.style.background = '#f3f4f6';
                trackingInput.style.borderColor = '#e5e7eb';
                trackingInput.style.color = '#9ca3af';
            }
            
            trackingInput.placeholder = 'Read-only';
        }
    }

    function updateOrderClick(orderId) {
        const order = allOrders.find(o => o.id === orderId);
        if (!order) {
            showCustomAlert('Error', 'Order not found', 'error');
            return;
        }
        
        const orderStatus = order.orderStatus || order.status || 'PENDING';
        
        // Prevent updates on RETURNED orders
        if (orderStatus === 'RETURNED') {
            showCustomAlert('Cannot Update ‚ö†Ô∏è', 'Returned orders cannot be updated. Please handle the return request first.', 'error');
            return;
        }
        
        const statusSelect = document.getElementById('status_' + orderId);
        const trackingInput = document.getElementById('tracking_' + orderId);
        
        if (!statusSelect || !trackingInput) {
            showCustomAlert('Error', 'Could not find order elements', 'error');
            return;
        }
        
        const newStatus = statusSelect.value;
        const trackingNumber = trackingInput.value.trim();
        
        // Only require tracking number when changing TO "SHIPPED" status
        if (newStatus === 'SHIPPED' && !trackingNumber) {
            showCustomAlert('Tracking Required ‚ö†Ô∏è', 'Please enter a tracking number for Label Sent status', 'error');
            trackingInput.focus();
            return;
        }
        
        const paymentStatus = order.paymentStatus || 'PENDING';
        
        // Determine if tracking details should be included in email
        // Only include tracking when status is SHIPPED
        const includeTracking = (newStatus === 'SHIPPED' && trackingNumber);
        
        updateOrderStatusAPI(orderId, newStatus, paymentStatus, trackingNumber, includeTracking);
    }

    async function updateOrderStatusAPI(orderId, orderStatus, paymentStatus, trackingNumber, includeTracking = false) {
        try {
            const statusDiv = document.getElementById('trackingStatus_' + orderId);
            if (statusDiv) {
                statusDiv.innerHTML = '<span style="color:#f59e0b;font-size:0.65rem;">‚è≥</span>';
            }
            
            let url = `/api/admin/orders/${orderId}?orderStatus=${orderStatus}&paymentStatus=${paymentStatus}`;
            
            // Always include tracking number if it exists (for database update)
            if (trackingNumber) {
                url += `&trackingNumber=${encodeURIComponent(trackingNumber)}`;
            }
            
            // Control whether to include tracking in the email
            // includeTracking will be true ONLY when status is SHIPPED
            url += `&includeTracking=${includeTracking}`;
            
            // Always send status update email
            url += `&sendEmail=true`;
            
            const response = await fetch(url, {
                method: 'PATCH',
                headers: { 
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const updatedOrder = await response.json();
                
                if (statusDiv) {
                    statusDiv.innerHTML = '<span style="color:#10b981;font-weight:600;font-size:0.65rem;">‚úì</span>';
                    setTimeout(() => statusDiv.innerHTML = '', 3000);
                }
                
                const index = allOrders.findIndex(o => o.id === orderId);
                if (index !== -1) {
                    allOrders[index] = updatedOrder;
                }
                
                // Build success message
                let message = `Order #${orderId} status updated to ${orderStatus}!`;
                if (includeTracking) {
                    message += ` Tracking email sent to customer.`;
                } else {
                    message += ` Status update email sent to customer.`;
                }
                
                showCustomAlert('Success! ‚úÖ', message, 'success');
                loadStats();
            } else {
                if (statusDiv) {
                    statusDiv.innerHTML = '<span style="color:#ef4444;font-size:0.65rem;">‚úó</span>';
                }
                showCustomAlert('Update Failed', 'Failed to update order', 'error');
            }
        } catch (error) {
            const statusDiv = document.getElementById('trackingStatus_' + orderId);
            if (statusDiv) {
                statusDiv.innerHTML = '<span style="color:#ef4444;font-size:0.65rem;">‚úó</span>';
            }
            showCustomAlert('Error', 'Failed to update: ' + error.message, 'error');
        }
    }

    function toggleMobileMenu() {
        const navLinks = document.getElementById('navLinks');
        const overlay = document.getElementById('navOverlay');
        const menuToggle = document.getElementById('menuToggle');
        
        if (!navLinks || !overlay || !menuToggle) return;
        
        const isActive = navLinks.classList.contains('active');
        
        if (isActive) {
            navLinks.classList.remove('active');
            overlay.classList.remove('active');
            menuToggle.textContent = '‚ò∞';
            menuToggle.style.fontSize = '1.8rem';
            document.body.style.overflow = 'auto';
        } else {
            navLinks.classList.add('active');
            overlay.classList.add('active');
            menuToggle.textContent = '√ó';
            menuToggle.style.fontSize = '2.5rem';
            document.body.style.overflow = 'hidden';
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const navLinks = document.querySelectorAll('.nav-links a, .nav-links button');
        navLinks.forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    const menu = document.getElementById('navLinks');
                    if (menu && menu.classList.contains('active')) {
                        toggleMobileMenu();
                    }
                }
            });
        });
    });
    
    window.addEventListener('resize', () => {
        if (window.innerWidth > 768) {
            const navLinks = document.getElementById('navLinks');
            const overlay = document.getElementById('navOverlay');
            const menuToggle = document.getElementById('menuToggle');
            
            if (navLinks) navLinks.classList.remove('active');
            if (overlay) overlay.classList.remove('active');
            if (menuToggle) {
                menuToggle.textContent = '‚ò∞';
                menuToggle.style.fontSize = '1.8rem';
            }
            document.body.style.overflow = 'auto';
        }
    });

    function viewOrderDetails(orderId) {
        const order = allOrders.find(o => o.id === orderId);
        if (!order) {
            showCustomAlert('Error', 'Order not found', 'error');
            return;
        }

        const items = order.items || [];
        const subtotal = order.subtotal || 0;
        const tax = order.tax || 0;
        const shipping = order.shipping || 0;
        const total = order.totalAmount || 0;
        const orderStatus = order.orderStatus || order.status || 'PENDING';
        
        const trackingNumber = order.trackingNumber || '';
        let carrier = order.carrier || 'USPS';
        
        if (trackingNumber && (!order.carrier || order.carrier === 'USPS')) {
            carrier = detectCarrier(trackingNumber);
        }
        
        const trackingUrl = trackingNumber ? getTrackingUrl(trackingNumber, carrier) : '#';
        const carrierEmoji = {
            'UPS': 'üì¶',
            'FEDEX': 'üöö',
            'DHL': '‚úàÔ∏è',
            'USPS': 'üìÆ',
            'AMAZON LOGISTICS': 'üì¶'
        }[carrier.toUpperCase()] || 'üì¶';
        
        // Return information section
        let returnSection = '';
        if (orderStatus === 'RETURNED') {
            const returnDate = order.returnRequestDate ? new Date(order.returnRequestDate).toLocaleString() : 'N/A';
            returnSection = `
                <div class="detail-section" style="background:#fef3c7;border-left:4px solid #f59e0b;">
                    <h4 style="color:#92400e;">üîÑ Return Information</h4>
                    <div style="padding:0.5rem 0;border-bottom:1px solid rgba(245,158,11,0.2);">
                        <div style="color:#92400e;font-weight:700;font-size:0.85rem;margin-bottom:0.2rem;">RETURN STATUS</div>
                        <div style="color:#f59e0b;font-weight:800;">AWAITING PICKUP</div>
                    </div>
                    <div style="padding:0.5rem 0;border-bottom:1px solid rgba(245,158,11,0.2);">
                        <div style="color:#92400e;font-weight:700;font-size:0.85rem;margin-bottom:0.2rem;">RETURN REQUEST DATE</div>
                        <div>${returnDate}</div>
                    </div>
                    <div style="padding:0.5rem 0;">
                        <div style="color:#92400e;font-weight:700;font-size:0.85rem;margin-bottom:0.2rem;">ACTION REQUIRED</div>
                        <div style="color:#991b1b;font-weight:600;">Contact customer within 24-48 hours</div>
                    </div>
                    <div style="text-align:center;margin-top:1rem;padding-top:1rem;border-top:1px solid rgba(245,158,11,0.2);">
                        <button onclick="closeCustomAlert(); toggleSection('returnedOrdersSection');" style="padding:0.8rem 1.5rem;background:#f59e0b;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                            üì¶ Go to Returned Orders Section
                        </button>
                    </div>
                </div>
            `;
        }
        
        const itemsList = items.map(item => `
            <div style="padding:0.8rem 0;border-bottom:1px solid #e5e7eb;">
                <div style="font-weight:600;margin-bottom:0.3rem;">${item.productName || 'Product'}</div>
                <div style="display:flex;justify-content:space-between;color:#6b7280;font-size:0.9rem;">
                    <span>Qty: ${item.quantity || 1} √ó $${(item.price || 0).toFixed(2)}</span>
                    <span style="font-weight:700;color:#10b981;">$${((item.price || 0) * (item.quantity || 1)).toFixed(2)}</span>
                </div>
            </div>
        `).join('');

        const content = `
            <div class="order-details-content">
                <div style="display:grid;grid-template-columns:1fr;gap:1rem;margin-bottom:1rem;">
                    <div class="detail-section">
                        <h4>üì¶ Order Information</h4>
                        <div style="padding:0.5rem 0;border-bottom:1px solid #e5e7eb;">
                            <div style="color:#667eea;font-weight:700;font-size:0.85rem;margin-bottom:0.2rem;">ORDER ID</div>
                            <div>#${order.id}</div>
                        </div>
                        <div style="padding:0.5rem 0;border-bottom:1px solid #e5e7eb;">
                            <div style="color:#667eea;font-weight:700;font-size:0.85rem;margin-bottom:0.2rem;">DATE</div>
                            <div>${new Date(order.orderDate || order.createdAt).toLocaleString()}</div>
                        </div>
                        <div style="padding:0.5rem 0;">
                            <div style="color:#667eea;font-weight:700;font-size:0.85rem;margin-bottom:0.2rem;">STATUS</div>
                            <span class="order-status status-${orderStatus.toLowerCase()}">${orderStatus}</span>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4>üë§ Customer</h4>
                        <div style="padding:0.5rem 0;border-bottom:1px solid #e5e7eb;">
                            <div style="color:#667eea;font-weight:700;font-size:0.85rem;margin-bottom:0.2rem;">NAME</div>
                            <div>${order.user ? order.user.name : 'N/A'}</div>
                        </div>
                        <div style="padding:0.5rem 0;">
                            <div style="color:#667eea;font-weight:700;font-size:0.85rem;margin-bottom:0.2rem;">EMAIL</div>
                            <div style="word-break:break-all;">${order.user ? order.user.email : 'N/A'}</div>
                        </div>
                    </div>
                </div>

                ${returnSection}

                ${trackingNumber ? `
                    <div class="detail-section" style="background:#dbeafe;border-left:4px solid #3b82f6;">
                        <h4 style="color:#1e40af;">üöö Tracking Information</h4>
                        <div style="padding:0.5rem 0;border-bottom:1px solid rgba(59,130,246,0.2);">
                            <div style="color:#1e40af;font-weight:700;font-size:0.85rem;margin-bottom:0.2rem;">CARRIER</div>
                            <div style="color:#3b82f6;font-weight:800;font-size:1.1rem;">${carrierEmoji} ${carrier}</div>
                        </div>
                        <div style="padding:0.5rem 0;">
                            <div style="color:#1e40af;font-weight:700;font-size:0.85rem;margin-bottom:0.2rem;">TRACKING NUMBER</div>
                            <div style="color:#1e40af;font-family:monospace;font-size:1.1rem;font-weight:700;word-break:break-all;">${trackingNumber}</div>
                        </div>
                        <div style="text-align:center;margin-top:1rem;padding-top:1rem;border-top:1px solid rgba(59,130,246,0.2);">
                            <a href="${trackingUrl}" target="_blank" 
                               style="display:inline-block;padding:0.8rem 1.5rem;background:#3b82f6;color:white;text-decoration:none;border-radius:8px;font-weight:600;">
                                ${carrierEmoji} Track Package ‚Üí
                            </a>
                        </div>
                    </div>
                ` : ''}

                <div class="detail-section">
                    <h4>üìç Shipping Address</h4>
                    <p style="margin:0.3rem 0;color:#374151;line-height:1.6;">${order.shippingStreet || 'N/A'}</p>
                    <p style="margin:0.3rem 0;color:#374151;">${order.shippingCity || 'N/A'}, ${order.shippingState || 'N/A'} ${order.shippingZipCode || ''}</p>
                    <p style="margin:0.3rem 0;color:#374151;">${order.shippingCountry || 'USA'}</p>
                </div>

                <div class="detail-section">
                    <h4>üõçÔ∏è Order Items (${items.length})</h4>
                    ${itemsList || '<p style="color:#6b7280;text-align:center;padding:1rem;">No items</p>'}
                </div>

                <div class="detail-section" style="background:#f0fdf4;border-left:4px solid #10b981;">
                    <h4 style="color:#065f46;">üí∞ Payment Summary</h4>
                    <div style="padding:0.5rem 0;border-bottom:1px solid #d1fae5;display:flex;justify-content:space-between;">
                        <span><strong>Subtotal:</strong></span>
                        <span>$${subtotal.toFixed(2)}</span>
                    </div>
                    <div style="padding:0.5rem 0;border-bottom:1px solid #d1fae5;display:flex;justify-content:space-between;">
                        <span><strong>Tax:</strong></span>
                        <span>$${tax.toFixed(2)}</span>
                    </div>
                    <div style="padding:0.5rem 0;border-bottom:1px solid #d1fae5;display:flex;justify-content:space-between;">
                        <span><strong>Shipping:</strong></span>
                        <span>${shipping === 0 ? '<span style="color:#10b981;font-weight:700;">FREE</span>' : '$' + shipping.toFixed(2)}</span>
                    </div>
                    <div style="padding:0.8rem 0;padding-top:1rem;border-top:2px solid #10b981;margin-top:0.5rem;display:flex;justify-content:space-between;align-items:center;">
                        <span style="font-size:1.2rem;"><strong>Total:</strong></span>
                        <span style="font-size:1.5rem;font-weight:800;color:#10b981;">$${total.toFixed(2)}</span>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('alertIcon').textContent = 'üì¶';
        document.getElementById('alertIcon').style.color = '#3b82f6';
        showCustomAlert('Order #' + orderId, '', 'success', content);
    }

    document.getElementById('addProductForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const productData = {
            name: document.getElementById('productName').value,
            description: document.getElementById('productDescription').value,
            price: parseFloat(document.getElementById('productPrice').value),
            category: document.getElementById('productCategory').value,
            stock: parseInt(document.getElementById('productStock').value),
            imageUrl: document.getElementById('productImage').value
        };

        try {
            const response = await fetch('/api/products', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(productData)
            });

            if (response.ok) {
                showCustomAlert('Product Added! ‚úÖ', 'Product has been added successfully', 'success');
                document.getElementById('addProductForm').reset();
                toggleSection('productSection');
                loadStats();
            } else {
                showCustomAlert('Error', 'Failed to add product', 'error');
            }
        } catch (error) {
            showCustomAlert('Error', 'Error adding product: ' + error.message, 'error');
        }
    });

    document.getElementById('shippingConfigForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const shippingCost = parseFloat(document.getElementById('shippingCost').value);
        const freeShippingThreshold = parseFloat(document.getElementById('freeShippingThreshold').value);
        
        if (shippingCost < 0 || freeShippingThreshold < 0) {
            showCustomAlert('Invalid Input ‚ö†Ô∏è', 'Values cannot be negative', 'error');
            return;
        }
        
        try {
            const response = await fetch(`/api/admin/shipping?shippingCost=${shippingCost}&freeShippingThreshold=${freeShippingThreshold}`, {
                method: 'PUT',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            
            if (response.ok) {
                const config = await response.json();
                showCustomAlert('Settings Saved! ‚úÖ', 'Shipping configuration updated successfully', 'success');
                document.getElementById('currentShippingCost').textContent = config.shippingCost.toFixed(2);
                document.getElementById('currentThreshold').textContent = config.freeShippingThreshold.toFixed(2);
            } else {
                showCustomAlert('Error', 'Failed to update shipping settings', 'error');
            }
        } catch (error) {
            showCustomAlert('Error', 'Error updating settings: ' + error.message, 'error');
        }
    });

    initNavbar();
    loadStats();
    loadOrders();
</script>
</body>
</html>