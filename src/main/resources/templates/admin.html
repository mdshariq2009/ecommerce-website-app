<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <title>Admin Dashboard - E-Commerce Store</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        *, *::before, *::after {
            box-sizing: border-box;
        }

        html, body {
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }

        .admin-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .page-header {
            margin-bottom: 3rem;
            text-align: center;
        }

        .page-title {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: #6b7280;
            font-size: 1.1rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 2px solid #f3f4f6;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: #1f2937;
            margin-bottom: 0.3rem;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Filters Section */
        .filters-section {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
            border: 2px solid #f3f4f6;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-group label {
            font-weight: 600;
            color: #374151;
            font-size: 0.95rem;
        }

        .filter-select, .search-input {
            padding: 0.6rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .filter-select:focus, .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-input {
            min-width: 200px;
        }

        /* Section Cards */
        .section-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            border: 2px solid #f3f4f6;
            overflow: hidden;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f9fafb 0%, #e0e7ff 100%);
            border-bottom: 2px solid #e5e7eb;
        }

        .section-header:hover {
            background: linear-gradient(135deg, #f3f4f6 0%, #dbeafe 100%);
        }

        .section-title {
            font-size: 1.3rem;
            color: #1f2937;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toggle-icon {
            font-size: 1.5rem;
            color: #667eea;
            transition: transform 0.3s ease;
        }

        .toggle-icon.expanded {
            transform: rotate(180deg);
        }

        .section-content {
            padding: 2rem;
            display: none;
        }

        .section-content.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Orders Table */
        .orders-table-wrapper {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 2px solid #f3f4f6;
            overflow: hidden;
        }

        .table-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .orders-table, .users-table {
            width: 100%;
            border-collapse: collapse;
        }

        .orders-table thead, .users-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .orders-table th, .users-table th {
            padding: 1.2rem 1rem;
            text-align: center;
            font-weight: 700;
            color: white;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: none;
        }

        .orders-table td, .users-table td {
            padding: 1.2rem 1rem;
            border-bottom: 1px solid #f3f4f6;
            text-align: center;
        }

        .orders-table tbody tr, .users-table tbody tr {
            transition: all 0.3s ease;
            background: white;
        }

        .orders-table tbody tr:nth-child(even), .users-table tbody tr:nth-child(even) {
            background: #f9fafb;
        }

        .orders-table tbody tr:hover, .users-table tbody tr:hover {
            background: #f3f4f6;
            transform: scale(1.01);
        }

        .order-status {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            display: inline-block;
        }

        .status-pending { background: #fef3c7; color: #92400e; }
        .status-processing { background: #dbeafe; color: #1e40af; }
        .status-shipped { background: #e0e7ff; color: #4338ca; }
        .status-delivered { background: #d1fae5; color: #065f46; }
        .status-cancelled { background: #fee2e2; color: #991b1b; }
        .status-completed { background: #d1fae5; color: #065f46; }

        .role-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            display: inline-block;
        }

        .role-admin {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .role-user {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        /* Modals */
        .custom-modal {
            display: none;
            position: fixed;
            top: 2%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
            z-index: 10000;
            min-width: 600px;
            max-width: 900px;
            max-height: 96vh;
            overflow-y: auto;
            text-align: center;
        }
        
        .custom-modal.show {
            display: block;
            animation: modalSlideDown 0.3s ease;
        }
        
        @keyframes modalSlideDown {
            from { opacity: 0; top: -10%; }
            to { opacity: 1; top: 2%; }
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            z-index: 9999;
        }
        
        .modal-overlay.show {
            display: block;
        }

        .order-details-content {
            text-align: left;
            margin: 1.5rem 0;
            max-width: 100%;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
            gap: 1rem;
        }
        
        .detail-section {
            margin: 1rem 0;
            padding: 1.5rem;
            background: #f9fafb;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .detail-section h4 {
            margin-bottom: 1rem;
            color: #1f2937;
            font-size: 1.1rem;
        }

        .info-box {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            border-radius: 8px;
            color: #1e40af;
            margin: 1rem 0;
            font-size: 0.95rem;
        }

        input[id^="tracking"]:enabled {
            background: #dbeafe !important;
            border-color: #3b82f6 !important;
        }

        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid #f3f4f6;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .action-btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        .btn-view {
            background: #3b82f6;
            color: white;
        }

        .btn-view:hover {
            background: #2563eb;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .btn-update {
            background: #10b981;
            color: white;
        }

        .btn-update:hover {
            background: #059669;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .btn-delete:hover {
            background: #dc2626;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        /* ============================================
   RESPONSIVE STYLES FOR SMALL SCREENS
   ============================================ */
@media (max-width: 768px) {
    body {
        overflow-x: hidden;
        width: 100%;
        max-width: 100vw;
    }

    .admin-container {
        padding: 0 0.5rem;
        margin: 0.5rem auto;
        max-width: 100%;
        width: 100%;
    }

    .page-header {
        margin-bottom: 1rem;
        padding: 0 0.25rem;
    }

    .page-title {
        font-size: 1.5rem;
    }

    .page-subtitle {
        font-size: 0.85rem;
    }

    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
    }

    .stat-card {
        padding: 0.75rem 0.5rem;
    }

    .stat-value {
        font-size: 1.3rem;
    }

    .stat-icon {
        font-size: 1.5rem;
    }

    .stat-label {
        font-size: 0.65rem;
    }

    /* Filters Section - Mobile Optimized */
    .filters-section {
        flex-direction: column;
        align-items: stretch;
        padding: 0.5rem;
        gap: 0.5rem;
    }

    .filter-group {
        width: 100%;
        flex-direction: column;
        align-items: stretch;
        gap: 0.25rem;
    }

    .filter-group label {
        font-size: 0.75rem;
        margin-bottom: 0.15rem;
    }

    .filter-select, .search-input {
        width: 100% !important;
        min-width: 100% !important;
        max-width: 100% !important;
        padding: 0.4rem 0.5rem !important;
        font-size: 0.75rem !important;
        box-sizing: border-box;
        height: 36px !important;
    }

    /* Section Content Forms */
    .section-content > form > div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
    }

    /* Hide Table Headers on Mobile */
    .orders-table thead, .users-table thead {
        display: none;
    }

    .orders-table, .users-table,
    .orders-table tbody, .users-table tbody,
    .orders-table tr, .users-table tr {
        display: block;
        width: 100%;
    }

    /* Order/User Cards - Compact */
    .orders-table tr, .users-table tr {
        margin-bottom: 0.75rem;
        border: 1.5px solid #e5e7eb;
        border-radius: 8px;
        padding: 0.5rem;
        background: white;
        box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        width: 100%;
        max-width: 100%;
        overflow: hidden;
        box-sizing: border-box;
    }

    .orders-table tr:hover, .users-table tr:hover {
        transform: none;
    }

    /* Table Cells - Mobile Layout */
    .orders-table td, .users-table td {
        display: block;
        width: 100%;
        max-width: 100%;
        text-align: left !important;
        padding: 0.35rem 0;
        border-bottom: 1px solid #f3f4f6;
        word-wrap: break-word;
        overflow-wrap: break-word;
        box-sizing: border-box;
    }

    .orders-table td:last-child, .users-table td:last-child {
        border-bottom: none;
        padding-bottom: 0.35rem;
        padding-top: 0.5rem;
    }

    /* Data Labels */
    .orders-table td::before, .users-table td::before {
        content: attr(data-label);
        display: block;
        font-weight: 700;
        color: #667eea;
        font-size: 0.65rem;
        text-transform: uppercase;
        margin-bottom: 0.25rem;
        letter-spacing: 0.3px;
    }

    .orders-table td:last-child::before, .users-table td:last-child::before {
        content: "ACTIONS";
        margin-bottom: 0.4rem;
    }

    /* ============================================
       CRITICAL: DROPDOWN (SELECT) - VERY COMPACT
       ============================================ */
    .orders-table select, .users-table select {
        width: 100% !important;
        max-width: 100% !important;
        min-width: 0 !important;
        box-sizing: border-box !important;
        padding: 0.35rem 1.5rem 0.35rem 0.4rem !important;
        font-size: 0.7rem !important;
        margin: 0 !important;
        height: 32px !important;
        line-height: 1.2 !important;
        border: 1.5px solid #d1d5db !important;
        border-radius: 5px !important;
        background-color: white !important;
        appearance: none !important;
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23667eea' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") !important;
        background-repeat: no-repeat !important;
        background-position: right 0.3rem center !important;
        background-size: 0.9em !important;
        cursor: pointer !important;
        font-weight: 600 !important;
        color: #374151 !important;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
    }

    /* Dropdown options */
    .orders-table select option, .users-table select option {
        padding: 0.4rem !important;
        font-size: 0.75rem !important;
    }

    /* ============================================
       CRITICAL: TEXT INPUT (TRACKING) - COMPACT
       ============================================ */
    .orders-table input[type="text"], .users-table input[type="text"] {
        width: 100% !important;
        max-width: 100% !important;
        min-width: 0 !important;
        box-sizing: border-box !important;
        padding: 0.35rem 0.4rem !important;
        font-size: 0.7rem !important;
        margin: 0 !important;
        height: 32px !important;
        line-height: 1.2 !important;
        border: 1.5px solid #d1d5db !important;
        border-radius: 5px !important;
        font-family: monospace !important;
    }

    /* Tracking input when enabled */
    .orders-table input[id^="tracking"]:enabled {
        background: #dbeafe !important;
        border-color: #3b82f6 !important;
        color: #1e40af !important;
        font-weight: 600 !important;
    }

    /* Tracking input when disabled */
    .orders-table input[id^="tracking"]:disabled {
        background: #f3f4f6 !important;
        border-color: #e5e7eb !important;
        color: #9ca3af !important;
    }

    /* ============================================
       CRITICAL: ACTION BUTTONS - VERY COMPACT
       ============================================ */
    .orders-table td:last-child,
    .users-table td:last-child {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        padding: 0.5rem 0 0.35rem 0 !important;
        width: 100%;
    }

    .action-btn {
        padding: 0.45rem 0.5rem !important;
        font-size: 0.7rem !important;
        margin-bottom: 0 !important;
        width: 100% !important;
        max-width: 100% !important;
        min-height: 32px !important;
        height: 32px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        box-sizing: border-box !important;
        white-space: nowrap !important;
        text-align: center !important;
        font-weight: 700 !important;
        border-radius: 5px !important;
        line-height: 1 !important;
    }

    /* Table Header - Mobile */
    .table-header {
        flex-direction: column;
        gap: 0.5rem;
        text-align: center;
        padding: 0.75rem 0.5rem;
    }

    .table-header button {
        padding: 0.45rem 0.75rem !important;
        font-size: 0.75rem !important;
        width: 100%;
        max-width: 100%;
        height: 36px !important;
    }

    .table-title {
        font-size: 1rem;
    }

    /* Filter Section Buttons */
    .filters-section button {
        padding: 0.45rem 0.75rem !important;
        font-size: 0.75rem !important;
        height: 36px !important;
    }

    /* ============================================
       MODALS - FULL SCREEN ON MOBILE
       ============================================ */
    .custom-modal {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        transform: none !important;
        min-width: 100% !important;
        max-width: 100% !important;
        width: 100% !important;
        height: 100vh !important;
        max-height: 100vh !important;
        padding: 1.5rem 1rem 1rem 1rem !important;
        margin: 0 !important;
        border-radius: 0 !important;
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch;
    }

    /* Main Close Button - Sticky at Bottom - SMALLER SIZE */
    #mainCloseBtn {
        position: sticky !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        width: calc(100% + 2rem) !important;
        margin: 1rem -1rem -1rem -1rem !important;
        padding: 0.6rem !important;
        border-radius: 0 !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        font-weight: 600 !important;
        font-size: 0.85rem !important;
        box-shadow: 0 -4px 15px rgba(0,0,0,0.2) !important;
        z-index: 100 !important;
        border: none !important;
        text-transform: uppercase !important;
        letter-spacing: 0.5px !important;
    }

    /* Ensure modal content has proper padding */
    #alertContent {
        padding-bottom: 1rem !important;
        margin-bottom: 0.5rem !important;
    }

    #customAlert {
        font-size: 0.8rem;
    }

    #alertTitle {
        font-size: 1.1rem !important;
        margin-top: 0.4rem !important;
        margin-bottom: 0.5rem !important;
    }

    #alertMessage {
        font-size: 0.8rem !important;
    }

    #alertIcon {
        font-size: 2.2rem !important;
        margin-top: 0.3rem !important;
        margin-bottom: 0.5rem !important;
    }

    .order-details-content {
        margin: 0.3rem 0 !important;
    }

    .order-details-content > div[style*="grid"] {
        display: block !important;
    }

    .detail-section {
        padding: 0.65rem !important;
        margin: 0.5rem 0 !important;
    }

    .detail-section h4 {
        font-size: 0.9rem !important;
        margin-bottom: 0.5rem !important;
    }

    .detail-row {
        display: block !important;
        padding: 0.3rem 0 !important;
    }

    .detail-row > span, .detail-row > div {
        display: block !important;
        margin-bottom: 0.2rem;
        font-size: 0.75rem;
    }

    .detail-row > span:first-child, .detail-row > div:first-child {
        color: #667eea !important;
        font-weight: 700 !important;
        font-size: 0.7rem !important;
    }

    /* Delete Confirmation Modal */
    #deleteConfirmModal {
        min-width: 100% !important;
        padding: 1.5rem 1rem 1rem 1rem !important;
    }

    #deleteConfirmModal > div[style*="display:flex"] {
        flex-direction: column !important;
        gap: 0.4rem !important;
    }

    #deleteConfirmModal > div[style*="display:flex"] button {
        width: 100% !important;
        min-width: 100% !important;
        max-width: 100% !important;
        margin: 0 !important;
        padding: 0.55rem !important;
        font-size: 0.8rem !important;
    }

    /* Section Content */
    .section-content {
        padding: 0.75rem !important;
    }

    .info-box {
        padding: 0.6rem !important;
        font-size: 0.75rem !important;
    }

    .section-content form button[type="submit"] {
        padding: 0.55rem 0.75rem !important;
        font-size: 0.8rem !important;
    }

    /* Order Status Badges */
    .order-status {
        padding: 0.25rem 0.45rem !important;
        font-size: 0.65rem !important;
        display: inline-block;
        max-width: fit-content;
    }

    .role-badge {
        padding: 0.25rem 0.45rem !important;
        font-size: 0.65rem !important;
    }

    #ordersContainer {
        padding: 0.5rem !important;
    }

    .section-header {
        padding: 0.75rem 0.5rem;
    }

    .section-title {
        font-size: 0.9rem;
    }

    .orders-table-wrapper {
        overflow-x: hidden;
        max-width: 100%;
        width: 100%;
    }

    /* Tracking Status Indicator */
    .orders-table td > div[id^="trackingStatus"] {
        font-size: 0.6rem !important;
        margin-top: 0.15rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Small text elements */
    .orders-table td small,
    .orders-table td div,
    .users-table td small,
    .users-table td div {
        font-size: 0.75rem;
        line-height: 1.3;
    }

    .orders-table td strong,
    .users-table td strong {
        font-size: 0.8rem;
    }
}

/* ============================================
   EXTRA SMALL SCREENS (< 480px)
   ============================================ */
@media (max-width: 480px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }

    .stat-card {
        padding: 0.75rem 0.5rem;
    }

    .stat-value {
        font-size: 1.2rem;
    }

    .page-title {
        font-size: 1.3rem;
    }

    .section-title {
        font-size: 0.85rem;
    }

    .orders-table td, .users-table td {
        padding: 0.3rem 0;
    }

    .orders-table td::before, .users-table td::before {
        font-size: 0.6rem;
        margin-bottom: 0.2rem;
    }

    /* EXTRA COMPACT for very small screens */
    .action-btn {
        padding: 0.4rem 0.45rem !important;
        font-size: 0.65rem !important;
        min-height: 30px !important;
        height: 30px !important;
    }

    .orders-table select, .users-table select {
        padding: 0.3rem 1.4rem 0.3rem 0.35rem !important;
        font-size: 0.65rem !important;
        height: 30px !important;
    }

    .orders-table input[type="text"], .users-table input[type="text"] {
        padding: 0.3rem 0.35rem !important;
        font-size: 0.65rem !important;
        height: 30px !important;
    }

    .custom-modal {
        padding: 1.25rem 0.85rem 0.85rem 0.85rem !important;
    }

    .detail-section {
        padding: 0.55rem !important;
        margin: 0.4rem 0 !important;
    }

    #alertTitle {
        font-size: 1rem !important;
    }

    #alertIcon {
        font-size: 1.8rem !important;
    }

    .table-title {
        font-size: 0.95rem;
    }

    .filter-select, .search-input {
        padding: 0.35rem 0.45rem !important;
        font-size: 0.7rem !important;
        height: 32px !important;
    }

    .orders-table tr, .users-table tr {
        padding: 0.45rem;
    }

    .orders-table td small,
    .orders-table td div,
    .users-table td small,
    .users-table td div {
        font-size: 0.7rem;
    }

    .orders-table td strong,
    .users-table td strong {
        font-size: 0.75rem;
    }

    /* Smaller close button on very small screens */
    #mainCloseBtn {
        padding: 0.55rem !important;
        font-size: 0.8rem !important;
    }
}
    </style>
</head>
<body>
    <!-- Custom Alert Modal -->
    <div class="modal-overlay" id="alertOverlay" onclick="closeCustomAlert()"></div>
    <div class="custom-modal" id="customAlert">
        <div id="alertIcon" style="font-size:4rem;margin-bottom:1rem;">‚úÖ</div>
        <h3 id="alertTitle" style="font-size:1.8rem;margin-bottom:1rem;color:#1f2937;">Success</h3>
        <p id="alertMessage" style="color:#6b7280;font-size:1.1rem;margin-bottom:2rem;">Operation completed successfully</p>
        <div id="alertContent"></div>
        <button class="btn" onclick="closeCustomAlert()" id="mainCloseBtn" style="margin-top:1.5rem;width:auto;padding:0.8rem 2.5rem;">Close</button>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteOverlay" onclick="closeDeleteConfirm()"></div>
    <div class="custom-modal" id="deleteConfirmModal" style="min-width:500px;">
        <div style="font-size:4rem;margin-bottom:1rem;color:#ef4444;">‚ö†Ô∏è</div>
        <h3 style="color:#ef4444;font-size:1.8rem;margin-bottom:1rem;">Delete Order?</h3>
        <p style="color:#6b7280;font-size:1.1rem;margin-bottom:1.5rem;">This action cannot be undone!</p>
        <div id="deleteOrderInfo" style="background:#fee2e2;padding:1.5rem;border-radius:12px;margin:1.5rem 0;border-left:4px solid #ef4444;">
            <p style="margin:0;color:#991b1b;"><strong>Order ID:</strong> #<span id="deleteOrderId"></span></p>
            <p style="margin:0.5rem 0 0 0;color:#991b1b;"><strong>Customer:</strong> <span id="deleteCustomerName"></span></p>
        </div>
        <div style="display:flex;gap:1rem;margin-top:2rem;flex-wrap:wrap;">
            <button onclick="closeDeleteConfirm()" class="btn" style="flex:1;background:linear-gradient(135deg, #6b7280 0%, #4b5563 100%);min-width:120px;">Cancel</button>
            <button onclick="deleteOrderConfirmed()" class="btn btn-danger" style="flex:1;min-width:120px;">Yes, Delete Order</button>
        </div>
    </div>

<div class="nav-overlay" id="navOverlay" onclick="toggleMobileMenu()"></div>

<nav class="navbar">
    <h1 onclick="window.location.href='/'">üõí E-Commerce Store</h1>
    
    <button class="menu-toggle" id="menuToggle" onclick="toggleMobileMenu()">‚ò∞</button>
    
    <div class="nav-links" id="navLinks">
        <a href="/">Home</a>
        <a href="/web/admin" id="adminLink" style="display:none;">Dashboard</a>
        <a href="/web/products">Products</a>
        <a href="/web/cart">Cart (<span id="cartCount">0</span>)</a>
        <a href="/web/orders" id="ordersLink" style="display:none;">My Orders</a>
        <a href="/web/profile" id="profileLink" style="display:none;">Profile</a>
        
        <span id="userName"></span>
        <button id="logoutBtn" style="display:none;" onclick="logout()">Logout</button>
    </div>
</nav>

    <div class="admin-container">
        <div class="page-header">
            <h1 class="page-title">üëë Admin Dashboard</h1>
            <p class="page-subtitle">Manage your store, products, and orders</p>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üì¶</div>
                <div class="stat-value" id="totalOrders">0</div>
                <div class="stat-label">Total Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-value" id="totalUsers">0</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üõçÔ∏è</div>
                <div class="stat-value" id="totalProducts">0</div>
                <div class="stat-label">Total Products</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-value">$<span id="totalRevenue">0</span></div>
                <div class="stat-label">Total Revenue</div>
            </div>
        </div>

        <!-- NEW: User Management Section -->
        <div class="section-card">
            <div class="section-header" onclick="toggleSection('usersSection')">
                <div class="section-title">üë• User Management</div>
                <div class="toggle-icon" id="usersToggle">‚ñº</div>
            </div>
            <div class="section-content" id="usersSection">
                <div style="background:#e0e7ff;padding:1.5rem;border-radius:12px;margin-bottom:1.5rem;border-left:4px solid #667eea;">
                    <p style="margin:0;color:#4338ca;"><strong>‚ÑπÔ∏è Registered Users:</strong> <span id="registeredUsersCount">0</span></p>
                    <p style="margin:0.5rem 0 0 0;color:#4338ca;">Admins: <strong><span id="adminUsersCount">0</span></strong> | Regular Users: <strong><span id="regularUsersCount">0</span></strong></p>
                </div>
                
                <div id="usersContainer" style="margin-top:1.5rem;">
                    <div style="text-align:center;padding:2rem;">
                        <div class="loading-spinner"></div>
                        <p style="color:#6b7280;margin-top:1rem;">Loading users...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shipping Settings Section -->
        <div class="section-card">
            <div class="section-header" onclick="toggleSection('shippingSection')">
                <div class="section-title">üöö Shipping Settings</div>
                <div class="toggle-icon" id="shippingToggle">‚ñº</div>
            </div>
            <div class="section-content" id="shippingSection">
                <div style="background:#d1fae5;padding:1.5rem;border-radius:12px;margin-bottom:1.5rem;border-left:4px solid #10b981;">
                    <p style="margin:0;color:#065f46;"><strong>‚ÑπÔ∏è Current Settings:</strong></p>
                    <p style="margin:0.5rem 0 0 0;color:#065f46;">Shipping Cost: <strong>$<span id="currentShippingCost">10.00</span></strong></p>
                    <p style="margin:0.5rem 0 0 0;color:#065f46;">Free Shipping Threshold: <strong>$<span id="currentThreshold">50.00</span></strong></p>
                </div>
                
                <form id="shippingConfigForm">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:2rem;">
                        <div class="form-group">
                            <label>Shipping Cost ($)</label>
                            <input type="number" id="shippingCost" step="0.01" min="0" required placeholder="e.g., 10.00">
                            <small style="color:#6b7280;">Cost charged for orders below threshold</small>
                        </div>
                        <div class="form-group">
                            <label>Free Shipping Threshold ($)</label>
                            <input type="number" id="freeShippingThreshold" step="0.01" min="0" required placeholder="e.g., 50.00">
                            <small style="color:#6b7280;">Orders above this get free shipping</small>
                        </div>
                    </div>
                    
                    <div class="info-box">
                        <p style="margin:0;font-weight:600;">üí° Example</p>
                        <p style="margin:0.5rem 0 0 0;font-size:0.9rem;">
                            If shipping cost is $10 and threshold is $50, customers pay $10 for orders under $50, and get free shipping for $50+
                        </p>
                    </div>
                    
                    <button type="submit" class="btn btn-success" style="width:100%;margin-top:1rem;">üíæ Save Shipping Settings</button>
                </form>
            </div>
        </div>

        <!-- Add Product Section -->
        <div class="section-card">
            <div class="section-header" onclick="toggleSection('productSection')">
                <div class="section-title">‚ûï Add New Product</div>
                <div class="toggle-icon" id="productToggle">‚ñº</div>
            </div>
            <div class="section-content" id="productSection">
                <form id="addProductForm">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1.5rem;">
                        <div class="form-group">
                            <label>Product Name</label>
                            <input type="text" id="productName" required>
                        </div>
                        <div class="form-group">
                            <label>Price ($)</label>
                            <input type="number" id="productPrice" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="productDescription" required rows="3" style="resize:vertical;"></textarea>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:1.5rem;">
                        <div class="form-group">
                            <label>Category</label>
                            <input type="text" id="productCategory" required>
                        </div>
                        <div class="form-group">
                            <label>Stock Quantity</label>
                            <input type="number" id="productStock" required min="0">
                        </div>
                        <div class="form-group">
                            <label>Image URL</label>
                            <input type="text" id="productImage" value="https://via.placeholder.com/300">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success" style="width:100%;margin-top:1rem;">‚ûï Add Product</button>
                </form>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filters-section" id="filtersSection" style="display:none;">
            <div class="filter-group">
                <label>Search By Order ID:</label>
                <input type="text" class="search-input" id="orderIdSearch" placeholder="Enter Order ID..." oninput="filterOrders()">
            </div>
            <div class="filter-group">
                <label>Search By Customer:</label>
                <input type="text" class="search-input" id="customerSearch" placeholder="Customer name or email..." oninput="filterOrders()">
            </div>
            <div class="filter-group">
                <label>Status:</label>
                <select class="filter-select" id="statusFilter" onchange="filterOrders()">
                    <option value="all">All Statuses</option>
                    <option value="PENDING">Pending</option>
                    <option value="PROCESSING">Processing</option>
                    <option value="SHIPPED">Shipped</option>
                    <option value="DELIVERED">Delivered</option>
                    <option value="CANCELLED">Cancelled</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Sort by:</label>
                <select class="filter-select" id="sortFilter" onchange="filterOrders()">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="highest">Highest Amount</option>
                    <option value="lowest">Lowest Amount</option>
                </select>
            </div>
            <div style="margin-left:auto;">
                <button onclick="clearFilters()" class="btn" style="padding:0.6rem 1.5rem;width:100%;">
                    Clear Filters
                </button>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="orders-table-wrapper">
            <div class="table-header">
                <div class="table-title">üì¶ All Orders</div>
                <button onclick="loadOrders()" class="btn" style="background:rgba(255,255,255,0.2);border:2px solid white;color:white;padding:0.6rem 1.5rem;">
                    Refresh
                </button>
            </div>
            <div id="ordersContainer" style="padding:2rem;">
                <div style="text-align:center;padding:2rem;">
                    <div class="loading-spinner"></div>
                    <p style="color:#6b7280;margin-top:1rem;">Loading orders...</p>
                </div>
            </div>
        </div>
    </div>

<footer style="background:#1f2937;color:white;padding:3rem 2rem;margin-top:4rem;">
    <div style="max-width:1400px;margin:0 auto;">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:3rem;margin-bottom:3rem;">
            <div>
                <h3 style="font-size:1.5rem;margin-bottom:1rem;font-weight:800;">üõí E-Commerce Store</h3>
                <p style="color:#9ca3af;line-height:1.6;">Your trusted online shopping destination for quality products at great prices.</p>
            </div>
            <div>
                <h4 style="font-size:1.1rem;margin-bottom:1rem;font-weight:700;">Quick Links</h4>
                <ul style="list-style:none;padding:0;">
                    <li style="margin-bottom:0.5rem;"><a href="/" style="color:#9ca3af;text-decoration:none;">Home</a></li>
                    <li style="margin-bottom:0.5rem;"><a href="/web/products" style="color:#9ca3af;text-decoration:none;">Products</a></li>
                    <li style="margin-bottom:0.5rem;"><a href="/web/orders" style="color:#9ca3af;text-decoration:none;">My Orders</a></li>
                    <li style="margin-bottom:0.5rem;"><a href="/web/profile" style="color:#9ca3af;text-decoration:none;">Profile</a></li>
                </ul>
            </div>
            <div>
                <h4 style="font-size:1.1rem;margin-bottom:1rem;font-weight:700;">Customer Service</h4>
                <ul style="list-style:none;padding:0;">
                    <li style="margin-bottom:0.5rem;"><a href="/web/contact" style="color:#9ca3af;text-decoration:none;">Contact Us</a></li>
                    <li style="margin-bottom:0.5rem;"><a href="/web/returns" style="color:#9ca3af;text-decoration:none;">Returns & Refunds</a></li>
                    <li style="margin-bottom:0.5rem;"><a href="/web/privacy" style="color:#9ca3af;text-decoration:none;">Privacy Policy</a></li>
                </ul>
            </div>
            <div>
                <h4 style="font-size:1.1rem;margin-bottom:1rem;font-weight:700;">Get in Touch</h4>
                <p style="color:#9ca3af;margin-bottom:0.5rem;">üìß support@ecommerce.com</p>
                <p style="color:#9ca3af;margin-bottom:0.5rem;">üì± 1-800-SHOP-NOW</p>
                <p style="color:#9ca3af;">üìç 123 Commerce St, City, State 12345</p>
            </div>
        </div>
        <div style="border-top:1px solid #374151;padding-top:2rem;text-align:center;">
            <p style="color:#9ca3af;margin-bottom:0.5rem;">¬© <span id="currentYear"></span> E-Commerce Store. All rights reserved.</p>
            <p style="color:#6b7280;font-size:0.9rem;">Powered by Stripe | Secure Shopping Experience</p>
        </div>
    </div>
</footer>

<script>
    document.getElementById('currentYear').textContent = new Date().getFullYear();
</script>

    <script>
    const user = JSON.parse(localStorage.getItem('user'));
    const token = localStorage.getItem('token');
    let allOrders = [];
    let filteredOrders = [];
    let allUsers = [];
    let orderToDelete = null;

    console.log('üöÄ Admin Dashboard Loaded');

    if (!user || !token || user.role !== 'ADMIN') {
        alert('Admin access only!');
        window.location.href = '/web/login';
    }

    function updateCartCount() {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const count = cart.reduce((sum, item) => sum + item.quantity, 0);
        document.getElementById('cartCount').textContent = count;
    }

    function logout() {
        localStorage.clear();
        window.location.href = '/';
    }

    function initNavbar() {
        updateCartCount();
        
        if (user && token) {
            document.getElementById('userName').textContent = 'Hi, ' + user.name;
            document.getElementById('logoutBtn').style.display = 'block';
            document.getElementById('ordersLink').style.display = 'block';
            document.getElementById('profileLink').style.display = 'block';
            
            if (user.role === 'ADMIN') {
                document.getElementById('adminLink').style.display = 'block';
            }
        }
    }

    function toggleSection(sectionId) {
        const content = document.getElementById(sectionId);
        const toggle = document.getElementById(sectionId.replace('Section', 'Toggle'));
        
        if (content.classList.contains('show')) {
            content.classList.remove('show');
            toggle.classList.remove('expanded');
        } else {
            content.classList.add('show');
            toggle.classList.add('expanded');
            
            if (sectionId === 'shippingSection') {
                loadShippingConfig();
            } else if (sectionId === 'usersSection') {
                loadUsers();
            }
        }
    }

    function showCustomAlert(title, message, type = 'success', content = '') {
        const icon = document.getElementById('alertIcon');
        
        if (type === 'success') {
            icon.textContent = '‚úÖ';
            icon.style.color = '#10b981';
        } else {
            icon.textContent = '‚ùå';
            icon.style.color = '#ef4444';
        }
        
        document.getElementById('alertTitle').textContent = title;
        document.getElementById('alertMessage').textContent = message;
        document.getElementById('alertContent').innerHTML = content;
        document.getElementById('alertOverlay').classList.add('show');
        document.getElementById('customAlert').classList.add('show');
    }

    function closeCustomAlert() {
        document.getElementById('customAlert').classList.remove('show');
        document.getElementById('alertOverlay').classList.remove('show');
        document.getElementById('alertContent').innerHTML = '';
    }

    function clearFilters() {
        document.getElementById('orderIdSearch').value = '';
        document.getElementById('customerSearch').value = '';
        document.getElementById('statusFilter').value = 'all';
        document.getElementById('sortFilter').value = 'newest';
        filterOrders();
    }

    async function loadUsers() {
        try {
            document.getElementById('usersContainer').innerHTML = `
                <div style="text-align:center;padding:2rem;">
                    <div class="loading-spinner"></div>
                    <p style="color:#6b7280;margin-top:1rem;">Loading users...</p>
                </div>
            `;

            let response;
            let users = [];
            
            try {
                response = await fetch('/api/admin/users', {
                    headers: { 
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    users = await response.json();
                }
            } catch (e) {
                console.log('Primary endpoint failed, trying alternative...');
            }

            if (users.length === 0 && allOrders.length > 0) {
                console.log('üìã Extracting users from orders...');
                
                const userMap = new Map();
                allOrders.forEach(order => {
                    if (order.user && order.user.id) {
                        if (!userMap.has(order.user.id)) {
                            userMap.set(order.user.id, {
                                id: order.user.id,
                                name: order.user.name,
                                email: order.user.email,
                                role: order.user.role || 'USER',
                                createdAt: order.createdAt
                            });
                        }
                    }
                });
                
                users = Array.from(userMap.values());
            }

            allUsers = users;

            const adminCount = users.filter(u => u.role === 'ADMIN').length;
            const regularCount = users.filter(u => u.role === 'USER' || !u.role).length;
            
            document.getElementById('registeredUsersCount').textContent = users.length;
            document.getElementById('adminUsersCount').textContent = adminCount;
            document.getElementById('regularUsersCount').textContent = regularCount;

            if (users.length === 0) {
                document.getElementById('usersContainer').innerHTML = 
                    `<div class="empty-state">
                        <div style="font-size:4rem;opacity:0.5;margin-bottom:1rem;">üë•</div>
                        <h3 style="color:#1f2937;margin-bottom:0.5rem;">No Users Found</h3>
                        <p style="color:#6b7280;margin-bottom:1rem;">No registered users available</p>
                        <div style="background:#fef3c7;padding:1rem;border-radius:8px;border-left:4px solid #f59e0b;text-align:left;">
                            <p style="margin:0;color:#92400e;font-size:0.9rem;"><strong>‚ÑπÔ∏è Note:</strong> User data is extracted from orders. Users will appear here once they place orders.</p>
                        </div>
                    </div>`;
                return;
            }

            displayUsers(users);
        } catch (error) {
            console.error('Error loading users:', error);
            document.getElementById('usersContainer').innerHTML = 
                `<div class="empty-state">
                    <div style="font-size:3rem;color:#ef4444;margin-bottom:1rem;">‚ùå</div>
                    <h3 style="color:#1f2937;margin-bottom:0.5rem;">Error Loading Users</h3>
                    <p style="color:#6b7280;margin-bottom:1rem;">${error.message}</p>
                    <button onclick="loadUsers()" class="btn" style="margin-top:1rem;width:auto;padding:0.8rem 2rem;">üîÑ Retry</button>
                </div>`;
            
            if (allOrders.length > 0) {
                const userMap = new Map();
                allOrders.forEach(order => {
                    if (order.user && order.user.id) {
                        if (!userMap.has(order.user.id)) {
                            userMap.set(order.user.id, {
                                id: order.user.id,
                                name: order.user.name,
                                email: order.user.email,
                                role: order.user.role || 'USER',
                                createdAt: order.createdAt
                            });
                        }
                    }
                });
                
                const users = Array.from(userMap.values());
                if (users.length > 0) {
                    allUsers = users;
                    const adminCount = users.filter(u => u.role === 'ADMIN').length;
                    const regularCount = users.filter(u => u.role === 'USER' || !u.role).length;
                    
                    document.getElementById('registeredUsersCount').textContent = users.length;
                    document.getElementById('adminUsersCount').textContent = adminCount;
                    document.getElementById('regularUsersCount').textContent = regularCount;
                    
                    displayUsers(users);
                }
            }
        }
    }

    function displayUsers(users) {
        const html = `
            <div style="overflow-x:auto;">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Registered Date</th>
                            <th>Total Orders</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => {
                            const orderCount = allOrders.filter(o => o.user && o.user.id === user.id).length;
                            const registeredDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A';
                            
                            return `
                                <tr>
                                    <td data-label="User ID"><strong style="color:#667eea;">#${user.id}</strong></td>
                                    <td data-label="Name">
                                        <div style="font-weight:600;color:#1f2937;">${user.name}</div>
                                    </td>
                                    <td data-label="Email">
                                        <div style="color:#6b7280;word-break:break-all;">${user.email}</div>
                                    </td>
                                    <td data-label="Role">
                                        <span class="role-badge role-${user.role.toLowerCase()}">${user.role}</span>
                                    </td>
                                    <td data-label="Registered">
                                        <small style="color:#6b7280;">${registeredDate}</small>
                                    </td>
                                    <td data-label="Orders">
                                        <strong style="color:#10b981;">${orderCount}</strong>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;

        document.getElementById('usersContainer').innerHTML = html;
    }

    function detectCarrier(trackingNumber) {
        if (!trackingNumber) return 'USPS';
        
        const tracking = trackingNumber.trim().toUpperCase().replace(/\s+/g, '');
        
        if (tracking.match(/^1Z[A-Z0-9]{16}$/)) return 'UPS';
        if (tracking.match(/^T\d{10}$/)) return 'UPS';
        if (tracking.match(/^\d{18}$/)) return 'UPS';
        if (tracking.match(/^(94|92|93|82|71|61|42|41|40|23|03|02|01)\d{18,24}$/)) return 'USPS';
        if (tracking.match(/^[A-Z]{2}\d{9}US$/)) return 'USPS';
        if (tracking.match(/^\d{12}$/) && !tracking.match(/^(94|92|93|82|71|61|42|41|40|23|03|02|01)/)) return 'FedEx';
        
        const length = tracking.length;
        if (tracking.match(/^\d+$/) && [14, 15, 20, 22].includes(length)) return 'FedEx';
        if (tracking.match(/^(96|02|03|04|05|06|07|08|09)\d{10,20}$/)) return 'FedEx';
        if (tracking.match(/^\d{10,11}$/) && !tracking.match(/^(94|92|93|82|71|61|42|41|40|23|03|02|01)/)) return 'DHL';
        if (tracking.match(/^(JJD|JVGL|GM|LX|RX)\d{10,20}$/)) return 'DHL';
        if (tracking.match(/^TBA\d{12,13}$/)) return 'Amazon Logistics';
        
        return 'USPS';
    }

    function getTrackingUrl(trackingNumber, carrier) {
        if (!trackingNumber) return '#';
        
        switch (carrier.toUpperCase()) {
            case 'UPS': return `https://www.ups.com/track?tracknum=${trackingNumber}`;
            case 'FEDEX': return `https://www.fedex.com/fedextrack/?trknbr=${trackingNumber}`;
            case 'DHL': return `https://www.dhl.com/en/express/tracking.html?AWB=${trackingNumber}`;
            case 'USPS': return `https://tools.usps.com/go/TrackConfirmAction?tLabels=${trackingNumber}`;
            case 'AMAZON LOGISTICS': return `https://track.amazon.com/tracking/${trackingNumber}`;
            default: return `https://tools.usps.com/go/TrackConfirmAction?tLabels=${trackingNumber}`;
        }
    }

    function filterOrders() {
        const orderIdSearch = document.getElementById('orderIdSearch').value.trim().toLowerCase();
        const customerSearch = document.getElementById('customerSearch').value.trim().toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const sortFilter = document.getElementById('sortFilter').value;

        let filtered = [...allOrders];

        if (orderIdSearch) {
            filtered = filtered.filter(order => order.id.toString().includes(orderIdSearch));
        }

        if (customerSearch) {
            filtered = filtered.filter(order => {
                const customerName = order.user ? order.user.name.toLowerCase() : '';
                const customerEmail = order.user ? order.user.email.toLowerCase() : '';
                return customerName.includes(customerSearch) || customerEmail.includes(customerSearch);
            });
        }

        if (statusFilter !== 'all') {
            filtered = filtered.filter(order => {
                const orderStatus = order.orderStatus || order.status || 'PENDING';
                return orderStatus === statusFilter;
            });
        }

        if (sortFilter === 'newest') {
            filtered.sort((a, b) => new Date(b.orderDate || b.createdAt) - new Date(a.orderDate || a.createdAt));
        } else if (sortFilter === 'oldest') {
            filtered.sort((a, b) => new Date(a.orderDate || a.createdAt) - new Date(b.orderDate || b.createdAt));
        } else if (sortFilter === 'highest') {
            filtered.sort((a, b) => (b.totalAmount || 0) - (a.totalAmount || 0));
        } else if (sortFilter === 'lowest') {
            filtered.sort((a, b) => (a.totalAmount || 0) - (b.totalAmount || 0));
        }

        filteredOrders = filtered;
        displayOrders(filtered);
    }

    async function loadStats() {
        try {
            const response = await fetch('/api/admin/stats', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            
            if (response.ok) {
                const stats = await response.json();
                document.getElementById('totalOrders').textContent = stats.totalOrders || 0;
                document.getElementById('totalUsers').textContent = stats.totalUsers || 0;
                document.getElementById('totalProducts').textContent = stats.totalProducts || 0;
                document.getElementById('totalRevenue').textContent = (stats.totalRevenue || 0).toFixed(2);
            }
        } catch (error) {
            console.error('‚ùå Error loading stats:', error);
        }
    }

    async function loadOrders() {
        try {
            document.getElementById('ordersContainer').innerHTML = `
                <div style="text-align:center;padding:2rem;">
                    <div class="loading-spinner"></div>
                    <p style="color:#6b7280;margin-top:1rem;">Loading orders...</p>
                </div>
            `;

            const response = await fetch('/api/admin/orders', {
                headers: { 
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                document.getElementById('ordersContainer').innerHTML = 
                    `<div class="empty-state">
                        <div style="font-size:3rem;color:#ef4444;margin-bottom:1rem;">‚ùå</div>
                        <h3 style="color:#1f2937;margin-bottom:0.5rem;">Failed to Load Orders</h3>
                        <p style="color:#6b7280;margin-bottom:1.5rem;">Status: ${response.status}</p>
                        <button onclick="loadOrders()" class="btn">üîÑ Retry</button>
                    </div>`;
                return;
            }

            const orders = await response.json();
            allOrders = orders;
            filteredOrders = orders;

            if (orders.length === 0) {
                document.getElementById('filtersSection').style.display = 'none';
                document.getElementById('ordersContainer').innerHTML = 
                    `<div class="empty-state">
                        <div style="font-size:4rem;opacity:0.5;margin-bottom:1rem;">üì¶</div>
                        <h3 style="color:#1f2937;margin-bottom:0.5rem;">No Orders Yet</h3>
                        <p style="color:#6b7280;">Orders will appear here once customers start purchasing</p>
                    </div>`;
                return;
            }

            document.getElementById('filtersSection').style.display = 'flex';
            displayOrders(orders);
        } catch (error) {
            document.getElementById('ordersContainer').innerHTML = 
                `<div class="empty-state">
                    <div style="font-size:3rem;color:#ef4444;margin-bottom:1rem;">‚ùå</div>
                    <h3 style="color:#1f2937;margin-bottom:0.5rem;">Error Loading Orders</h3>
                    <p style="color:#6b7280;margin-bottom:1.5rem;">${error.message}</p>
                    <button onclick="loadOrders()" class="btn">üîÑ Retry</button>
                </div>`;
        }
    }

    function displayOrders(orders) {
        if (orders.length === 0) {
            document.getElementById('ordersContainer').innerHTML = 
                `<div class="empty-state">
                    <div style="font-size:3rem;opacity:0.5;margin-bottom:1rem;">üîç</div>
                    <h3 style="color:#1f2937;margin-bottom:0.5rem;">No Orders Found</h3>
                    <p style="color:#6b7280;margin-bottom:1.5rem;">Try adjusting your filters</p>
                    <button onclick="clearFilters()" class="btn">Clear Filters</button>
                </div>`;
            return;
        }

        const html = `
            <div style="overflow-x:auto;">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Payment</th>
                            <th>Order Status</th>
                            <th>Tracking Number</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${orders.map(order => {
                            const orderStatus = order.orderStatus || order.status || 'PENDING';
                            const paymentStatus = order.paymentStatus || 'PENDING';
                            
                            return `
                                <tr>
                                    <td data-label="Order ID"><strong style="color:#667eea;">#${order.id}</strong></td>
                                    <td data-label="Customer">
                                        <div style="font-weight:600;color:#1f2937;">${order.user ? order.user.name : 'N/A'}</div>
                                        <small style="color:#6b7280;word-break:break-all;">${order.user ? order.user.email : 'N/A'}</small>
                                    </td>
                                    <td data-label="Amount"><strong style="color:#10b981;">$${(order.totalAmount || 0).toFixed(2)}</strong></td>
                                    <td data-label="Payment"><span class="order-status status-${paymentStatus.toLowerCase()}">${paymentStatus}</span></td>
                                    <td data-label="Status">
                                        <select id="status_${order.id}" onchange="handleStatusChange(${order.id})">
                                            <option value="PENDING" ${orderStatus === 'PENDING' ? 'selected' : ''}>Pending</option>
                                            <option value="PROCESSING" ${orderStatus === 'PROCESSING' ? 'selected' : ''}>Processing</option>
                                            <option value="SHIPPED" ${orderStatus === 'SHIPPED' ? 'selected' : ''}>Shipped</option>
                                            <option value="DELIVERED" ${orderStatus === 'DELIVERED' ? 'selected' : ''}>Delivered</option>
                                            <option value="CANCELLED" ${orderStatus === 'CANCELLED' ? 'selected' : ''}>Cancelled</option>
                                        </select>
                                    </td>
                                    <td data-label="Tracking">
                                        <input 
                                            type="text" 
                                            id="tracking_${order.id}" 
                                            value="${order.trackingNumber || ''}" 
                                            placeholder="Track #"
                                        >
                                        <div id="trackingStatus_${order.id}"></div>
                                    </td>
                                    <td data-label="Date"><small style="color:#6b7280;">${new Date(order.orderDate || order.createdAt).toLocaleDateString()}</small></td>
                                    <td data-label="Actions">
                                        <button onclick="viewOrderDetails(${order.id})" class="action-btn btn-view">View</button>
                                        <button onclick="updateOrderClick(${order.id})" class="action-btn btn-update">Update</button>
                                        <button onclick="confirmDeleteOrder(${order.id})" class="action-btn btn-delete">Delete</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;

        document.getElementById('ordersContainer').innerHTML = html;
        orders.forEach(order => handleStatusChange(order.id));
    }

    function confirmDeleteOrder(orderId) {
        const order = allOrders.find(o => o.id === orderId);
        if (!order) {
            showCustomAlert('Error', 'Order not found', 'error');
            return;
        }
        
        orderToDelete = orderId;
        document.getElementById('deleteOrderId').textContent = orderId;
        document.getElementById('deleteCustomerName').textContent = order.user ? order.user.name : 'N/A';
        document.getElementById('deleteOverlay').classList.add('show');
        document.getElementById('deleteConfirmModal').classList.add('show');
    }

    function closeDeleteConfirm() {
        document.getElementById('deleteConfirmModal').classList.remove('show');
        document.getElementById('deleteOverlay').classList.remove('show');
        orderToDelete = null;
    }

    async function deleteOrderConfirmed() {
        if (!orderToDelete) return;
        
        try {
            const response = await fetch(`/api/admin/orders/${orderToDelete}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            });

            if (response.ok || response.status === 204) {
                closeDeleteConfirm();
                showCustomAlert('Order Deleted ‚úÖ', `Order #${orderToDelete} has been permanently deleted`, 'success');
                loadOrders();
                loadStats();
            } else {
                closeDeleteConfirm();
                showCustomAlert('Delete Failed', 'Failed to delete order', 'error');
            }
        } catch (error) {
            closeDeleteConfirm();
            showCustomAlert('Error', 'Error deleting order: ' + error.message, 'error');
        }
    }

    async function loadShippingConfig() {
        try {
            const response = await fetch('/api/admin/shipping', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            
            if (response.ok) {
                const config = await response.json();
                document.getElementById('currentShippingCost').textContent = config.shippingCost.toFixed(2);
                document.getElementById('currentThreshold').textContent = config.freeShippingThreshold.toFixed(2);
                document.getElementById('shippingCost').value = config.shippingCost;
                document.getElementById('freeShippingThreshold').value = config.freeShippingThreshold;
            }
        } catch (error) {
            console.error('Error loading shipping config:', error);
        }
    }

    function handleStatusChange(orderId) {
        const statusSelect = document.getElementById('status_' + orderId);
        const trackingInput = document.getElementById('tracking_' + orderId);
        
        if (!statusSelect || !trackingInput) return;
        
        const status = statusSelect.value;
        
        if (status === 'SHIPPED') {
            trackingInput.disabled = false;
            trackingInput.style.background = '#dbeafe';
            trackingInput.style.borderColor = '#3b82f6';
            trackingInput.style.color = '#1e40af';
            trackingInput.placeholder = 'Track #';
            
            if (!trackingInput.value) {
                setTimeout(() => trackingInput.focus(), 100);
            }
        } else {
            trackingInput.disabled = true;
            trackingInput.style.background = '#f3f4f6';
            trackingInput.style.borderColor = '#e5e7eb';
            trackingInput.style.color = '#9ca3af';
            trackingInput.placeholder = 'N/A';
        }
    }

    function updateOrderClick(orderId) {
        const statusSelect = document.getElementById('status_' + orderId);
        const trackingInput = document.getElementById('tracking_' + orderId);
        
        if (!statusSelect || !trackingInput) {
            showCustomAlert('Error', 'Could not find order elements', 'error');
            return;
        }
        
        const newStatus = statusSelect.value;
        const trackingNumber = trackingInput.value.trim();
        const order = allOrders.find(o => o.id === orderId);
        
        if (!order) {
            showCustomAlert('Error', 'Order not found', 'error');
            return;
        }
        
        if (newStatus === 'SHIPPED' && !trackingNumber) {
            showCustomAlert('Tracking Required ‚ö†Ô∏è', 'Please enter a tracking number for shipped orders', 'error');
            trackingInput.focus();
            return;
        }
        
        const paymentStatus = order.paymentStatus || 'PENDING';
        updateOrderStatusAPI(orderId, newStatus, paymentStatus, trackingNumber);
    }

    async function updateOrderStatusAPI(orderId, orderStatus, paymentStatus, trackingNumber) {
        try {
            const statusDiv = document.getElementById('trackingStatus_' + orderId);
            if (statusDiv) {
                statusDiv.innerHTML = '<span style="color:#f59e0b;font-size:0.65rem;">‚è≥</span>';
            }
            
            let url = `/api/admin/orders/${orderId}?orderStatus=${orderStatus}&paymentStatus=${paymentStatus}`;
            
            if (trackingNumber) {
                url += `&trackingNumber=${encodeURIComponent(trackingNumber)}`;
            }
            
            const response = await fetch(url, {
                method: 'PATCH',
                headers: { 
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const updatedOrder = await response.json();
                
                if (statusDiv) {
                    statusDiv.innerHTML = '<span style="color:#10b981;font-weight:600;font-size:0.65rem;">‚úì</span>';
                    setTimeout(() => statusDiv.innerHTML = '', 3000);
                }
                
                const index = allOrders.findIndex(o => o.id === orderId);
                if (index !== -1) {
                    allOrders[index] = updatedOrder;
                }
                
                showCustomAlert('Success! ‚úÖ', `Order #${orderId} updated successfully!`, 'success');
                loadStats();
            } else {
                if (statusDiv) {
                    statusDiv.innerHTML = '<span style="color:#ef4444;font-size:0.65rem;">‚úó</span>';
                }
                showCustomAlert('Update Failed', 'Failed to update order', 'error');
            }
        } catch (error) {
            const statusDiv = document.getElementById('trackingStatus_' + orderId);
            if (statusDiv) {
                statusDiv.innerHTML = '<span style="color:#ef4444;font-size:0.65rem;">‚úó</span>';
            }
            showCustomAlert('Error', 'Failed to update: ' + error.message, 'error');
        }
    }

    function toggleMobileMenu() {
        const navLinks = document.getElementById('navLinks');
        const overlay = document.getElementById('navOverlay');
        const menuToggle = document.getElementById('menuToggle');
        
        if (!navLinks || !overlay || !menuToggle) return;
        
        const isActive = navLinks.classList.contains('active');
        
        if (isActive) {
            navLinks.classList.remove('active');
            overlay.classList.remove('active');
            menuToggle.textContent = '‚ò∞';
            menuToggle.style.fontSize = '1.8rem';
            document.body.style.overflow = 'auto';
        } else {
            navLinks.classList.add('active');
            overlay.classList.add('active');
            menuToggle.textContent = '√ó';
            menuToggle.style.fontSize = '2.5rem';
            document.body.style.overflow = 'hidden';
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const navLinks = document.querySelectorAll('.nav-links a, .nav-links button');
        navLinks.forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    const menu = document.getElementById('navLinks');
                    if (menu && menu.classList.contains('active')) {
                        toggleMobileMenu();
                    }
                }
            });
        });
    });
    
    window.addEventListener('resize', () => {
        if (window.innerWidth > 768) {
            const navLinks = document.getElementById('navLinks');
            const overlay = document.getElementById('navOverlay');
            const menuToggle = document.getElementById('menuToggle');
            
            if (navLinks) navLinks.classList.remove('active');
            if (overlay) overlay.classList.remove('active');
            if (menuToggle) {
                menuToggle.textContent = '‚ò∞';
                menuToggle.style.fontSize = '1.8rem';
            }
            document.body.style.overflow = 'auto';
        }
    });

    function viewOrderDetails(orderId) {
        const order = allOrders.find(o => o.id === orderId);
        if (!order) {
            showCustomAlert('Error', 'Order not found', 'error');
            return;
        }

        const items = order.items || [];
        const subtotal = order.subtotal || 0;
        const tax = order.tax || 0;
        const shipping = order.shipping || 0;
        const total = order.totalAmount || 0;
        
        const trackingNumber = order.trackingNumber || '';
        let carrier = order.carrier || 'USPS';
        
        if (trackingNumber && (!order.carrier || order.carrier === 'USPS')) {
            carrier = detectCarrier(trackingNumber);
        }
        
        const trackingUrl = trackingNumber ? getTrackingUrl(trackingNumber, carrier) : '#';
        const carrierEmoji = {
            'UPS': 'üì¶',
            'FEDEX': 'üöö',
            'DHL': '‚úàÔ∏è',
            'USPS': 'üìÆ',
            'AMAZON LOGISTICS': 'üì¶'
        }[carrier.toUpperCase()] || 'üì¶';
        
        const itemsList = items.map(item => `
            <div style="padding:0.8rem 0;border-bottom:1px solid #e5e7eb;">
                <div style="font-weight:600;margin-bottom:0.3rem;">${item.productName || 'Product'}</div>
                <div style="display:flex;justify-content:space-between;color:#6b7280;font-size:0.9rem;">
                    <span>Qty: ${item.quantity || 1} √ó $${(item.price || 0).toFixed(2)}</span>
                    <span style="font-weight:700;color:#10b981;">$${((item.price || 0) * (item.quantity || 1)).toFixed(2)}</span>
                </div>
            </div>
        `).join('');

        const content = `
            <div class="order-details-content">
                <div style="display:grid;grid-template-columns:1fr;gap:1rem;margin-bottom:1rem;">
                    <div class="detail-section">
                        <h4>üì¶ Order Information</h4>
                        <div style="padding:0.5rem 0;border-bottom:1px solid #e5e7eb;">
                            <div style="color:#667eea;font-weight:700;font-size:0.85rem;margin-bottom:0.2rem;">ORDER ID</div>
                            <div>#${order.id}</div>
                        </div>
                        <div style="padding:0.5rem 0;border-bottom:1px solid #e5e7eb;">
                            <div style="color:#667eea;font-weight:700;font-size:0.85rem;margin-bottom:0.2rem;">DATE</div>
                            <div>${new Date(order.orderDate || order.createdAt).toLocaleString()}</div>
                        </div>
                        <div style="padding:0.5rem 0;">
                            <div style="color:#667eea;font-weight:700;font-size:0.85rem;margin-bottom:0.2rem;">STATUS</div>
                            <span class="order-status status-${(order.orderStatus || 'PENDING').toLowerCase()}">${order.orderStatus || 'PENDING'}</span>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4>üë§ Customer</h4>
                        <div style="padding:0.5rem 0;border-bottom:1px solid #e5e7eb;">
                            <div style="color:#667eea;font-weight:700;font-size:0.85rem;margin-bottom:0.2rem;">NAME</div>
                            <div>${order.user ? order.user.name : 'N/A'}</div>
                        </div>
                        <div style="padding:0.5rem 0;">
                            <div style="color:#667eea;font-weight:700;font-size:0.85rem;margin-bottom:0.2rem;">EMAIL</div>
                            <div style="word-break:break-all;">${order.user ? order.user.email : 'N/A'}</div>
                        </div>
                    </div>
                </div>

                ${trackingNumber ? `
                    <div class="detail-section" style="background:#dbeafe;border-left:4px solid #3b82f6;">
                        <h4 style="color:#1e40af;">üöö Tracking Information</h4>
                        <div style="padding:0.5rem 0;border-bottom:1px solid rgba(59,130,246,0.2);">
                            <div style="color:#1e40af;font-weight:700;font-size:0.85rem;margin-bottom:0.2rem;">CARRIER</div>
                            <div style="color:#3b82f6;font-weight:800;font-size:1.1rem;">${carrierEmoji} ${carrier}</div>
                        </div>
                        <div style="padding:0.5rem 0;">
                            <div style="color:#1e40af;font-weight:700;font-size:0.85rem;margin-bottom:0.2rem;">TRACKING NUMBER</div>
                            <div style="color:#1e40af;font-family:monospace;font-size:1.1rem;font-weight:700;word-break:break-all;">${trackingNumber}</div>
                        </div>
                        <div style="text-align:center;margin-top:1rem;padding-top:1rem;border-top:1px solid rgba(59,130,246,0.2);">
                            <a href="${trackingUrl}" target="_blank" 
                               style="display:inline-block;padding:0.8rem 1.5rem;background:#3b82f6;color:white;text-decoration:none;border-radius:8px;font-weight:600;">
                                ${carrierEmoji} Track Package ‚Üí
                            </a>
                        </div>
                    </div>
                ` : ''}

                <div class="detail-section">
                    <h4>üìç Shipping Address</h4>
                    <p style="margin:0.3rem 0;color:#374151;line-height:1.6;">${order.shippingStreet || 'N/A'}</p>
                    <p style="margin:0.3rem 0;color:#374151;">${order.shippingCity || 'N/A'}, ${order.shippingState || 'N/A'} ${order.shippingZipCode || ''}</p>
                    <p style="margin:0.3rem 0;color:#374151;">${order.shippingCountry || 'USA'}</p>
                </div>

                <div class="detail-section">
                    <h4>üõçÔ∏è Order Items (${items.length})</h4>
                    ${itemsList || '<p style="color:#6b7280;text-align:center;padding:1rem;">No items</p>'}
                </div>

                <div class="detail-section" style="background:#f0fdf4;border-left:4px solid #10b981;">
                    <h4 style="color:#065f46;">üí∞ Payment Summary</h4>
                    <div style="padding:0.5rem 0;border-bottom:1px solid #d1fae5;display:flex;justify-content:space-between;">
                        <span><strong>Subtotal:</strong></span>
                        <span>$${subtotal.toFixed(2)}</span>
                    </div>
                    <div style="padding:0.5rem 0;border-bottom:1px solid #d1fae5;display:flex;justify-content:space-between;">
                        <span><strong>Tax:</strong></span>
                        <span>$${tax.toFixed(2)}</span>
                    </div>
                    <div style="padding:0.5rem 0;border-bottom:1px solid #d1fae5;display:flex;justify-content:space-between;">
                        <span><strong>Shipping:</strong></span>
                        <span>${shipping === 0 ? '<span style="color:#10b981;font-weight:700;">FREE</span>' : '$' + shipping.toFixed(2)}</span>
                    </div>
                    <div style="padding:0.8rem 0;padding-top:1rem;border-top:2px solid #10b981;margin-top:0.5rem;display:flex;justify-content:space-between;align-items:center;">
                        <span style="font-size:1.2rem;"><strong>Total:</strong></span>
                        <span style="font-size:1.5rem;font-weight:800;color:#10b981;">$${total.toFixed(2)}</span>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('alertIcon').textContent = 'üì¶';
        document.getElementById('alertIcon').style.color = '#3b82f6';
        showCustomAlert('Order #' + orderId, '', 'success', content);
    }

    document.getElementById('addProductForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const productData = {
            name: document.getElementById('productName').value,
            description: document.getElementById('productDescription').value,
            price: parseFloat(document.getElementById('productPrice').value),
            category: document.getElementById('productCategory').value,
            stock: parseInt(document.getElementById('productStock').value),
            imageUrl: document.getElementById('productImage').value
        };

        try {
            const response = await fetch('/api/products', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(productData)
            });

            if (response.ok) {
                showCustomAlert('Product Added! ‚úÖ', 'Product has been added successfully', 'success');
                document.getElementById('addProductForm').reset();
                toggleSection('productSection');
                loadStats();
            } else {
                showCustomAlert('Error', 'Failed to add product', 'error');
            }
        } catch (error) {
            showCustomAlert('Error', 'Error adding product: ' + error.message, 'error');
        }
    });

    document.getElementById('shippingConfigForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const shippingCost = parseFloat(document.getElementById('shippingCost').value);
        const freeShippingThreshold = parseFloat(document.getElementById('freeShippingThreshold').value);
        
        if (shippingCost < 0 || freeShippingThreshold < 0) {
            showCustomAlert('Invalid Input ‚ö†Ô∏è', 'Values cannot be negative', 'error');
            return;
        }
        
        try {
            const response = await fetch(`/api/admin/shipping?shippingCost=${shippingCost}&freeShippingThreshold=${freeShippingThreshold}`, {
                method: 'PUT',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            
            if (response.ok) {
                const config = await response.json();
                showCustomAlert('Settings Saved! ‚úÖ', 'Shipping configuration updated successfully', 'success');
                document.getElementById('currentShippingCost').textContent = config.shippingCost.toFixed(2);
                document.getElementById('currentThreshold').textContent = config.freeShippingThreshold.toFixed(2);
            } else {
                showCustomAlert('Error', 'Failed to update shipping settings', 'error');
            }
        } catch (error) {
            showCustomAlert('Error', 'Error updating settings: ' + error.message, 'error');
        }
    });

    initNavbar();
    loadStats();
    loadOrders();
</script>
</body>
</html>